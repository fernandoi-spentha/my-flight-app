<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>MyFlight</title>
    <style>
    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        -webkit-tap-highlight-color: transparent
    }

    html, body {
        height: 100%;
        overflow: hidden
    }

    body {
        font-family: -apple-system, system-ui, 'Helvetica Neue', sans-serif;
        background: #0a0e1a;
        color: #e8edf5;
        -webkit-font-smoothing: antialiased;
    }

    .app {
        height: 100%;
        width: 100%;
        max-width: 430px;
        margin: 0 auto;
        position: relative;
        overflow: hidden
    }/* Screens */
    .scr {
        position: absolute;
        inset: 0;
        overflow-y: auto;
        overflow-x: hidden;
        padding: 20px;
        padding-top: calc(env(safe-area-inset-top, 0px) + 20px);
        padding-bottom: calc(env(safe-area-inset-bottom, 0px) + 20px);
        -webkit-overflow-scrolling: touch;
        transition: transform .4s ease, opacity .4s ease
    }

    .scr::-webkit-scrollbar {
        width: 0
    }

    .scr.off-r {
        transform: translateX(100%);
        opacity: 0;
        pointer-events: none
    }

    .scr.off-l {
        transform: translateX(-30%);
        opacity: 0;
        pointer-events: none
    }/* Search screen */
    .search {
        display: flex;
        flex-direction: column;
        padding-top: calc(env(safe-area-inset-top, 0px) + 60px)
    }

    .logo {
        text-align: center;
        margin-bottom: 48px
    }

    .logo-box {
        width: 72px;
        height: 72px;
        margin: 0 auto 20px;
        background: linear-gradient(135deg, #4e9eff, #7c3aed);
        border-radius: 22px;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 8px 32px rgba(78, 158, 255, .25)
    }

    .logo-box svg {
        width: 38px;
        height: 38px;
        fill: #fff
    }

    .logo h1 {
        font-size: 32px;
        font-weight: 700;
        letter-spacing: -.5px;
        margin-bottom: 8px
    }

    .logo p {
        font-size: 15px;
        color: #7a8ba8;
        line-height: 1.5;
        max-width: 280px;
        margin: 0 auto
    }

    .field-group {
        margin-bottom: 16px
    }

    .field-label {
        display: block;
        font-size: 12px;
        font-weight: 600;
        color: #7a8ba8;
        text-transform: uppercase;
        letter-spacing: 1px;
        margin-bottom: 8px
    }

    .field {
        width: 100%;
        padding: 16px 18px;
        background: #0d1220;
        border: 1.5px solid rgba(78, 158, 255, .1);
        border-radius: 10px;
        color: #e8edf5;
        font-family: 'SF Mono', Menlo, monospace;
        font-size: 18px;
        letter-spacing: 2px;
        outline: none;
        transition: border-color .2s, box-shadow .2s
    }

    .field::placeholder {
        color: #4a5873;
        letter-spacing: 1px;
        font-size: 15px
    }

    .field:focus {
        border-color: #4e9eff;
        box-shadow: 0 0 0 4px rgba(78, 158, 255, .15)
    }

    .field-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 12px
    }

    .field-date {
        font-family: -apple-system, sans-serif;
        font-size: 15px;
        letter-spacing: 0
    }

    .field-seat {
        letter-spacing: 1px
    }

    .select {
        width: 100%;
        padding: 16px 18px;
        background: #0d1220;
        border: 1.5px solid rgba(78, 158, 255, .1);
        border-radius: 10px;
        color: #e8edf5;
        font-family: -apple-system, sans-serif;
        font-size: 15px;
        outline: none;
        -webkit-appearance: none;
        appearance: none;
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' fill='%237a8ba8' viewBox='0 0 24 24'%3E%3Cpath d='M7 10l5 5 5-5z'/%3E%3C/svg%3E");
        background-repeat: no-repeat;
        background-position: right 16px center
    }

    .select:focus {
        border-color: #4e9eff;
        box-shadow: 0 0 0 4px rgba(78, 158, 255, .15)
    }

    .btn {
        width: 100%;
        padding: 18px;
        background: linear-gradient(135deg, #4e9eff, #3b82f6);
        color: #fff;
        border: none;
        border-radius: 10px;
        font-family: -apple-system, sans-serif;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        transition: transform .15s
    }

    .btn:active {
        transform: scale(.97)
    }

    .examples {
        margin-top: auto
    }

    .examples-title {
        font-size: 12px;
        font-weight: 600;
        color: #4a5873;
        text-transform: uppercase;
        letter-spacing: 1px;
        margin-bottom: 12px
    }

    .chips {
        display: flex;
        flex-wrap: wrap;
        gap: 8px
    }

    .chip {
        padding: 10px 16px;
        background: #131829;
        border: 1px solid rgba(78, 158, 255, .1);
        border-radius: 100px;
        color: #7a8ba8;
        font-family: 'SF Mono', Menlo, monospace;
        font-size: 13px;
        cursor: pointer
    }

    .chip:active {
        background: #1a2035;
        color: #4e9eff
    }/* Loading */
    .loading {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        text-align: center;
        gap: 32px
    }

    .spinner {
        width: 64px;
        height: 64px;
        border: 3px solid rgba(78, 158, 255, .1);
        border-top-color: #4e9eff;
        border-radius: 50%;
        animation: spin 1s linear infinite
    }

    @keyframes spin {
        to {
            transform: rotate(360deg)
        }
    }

    .steps {
        display: flex;
        flex-direction: column;
        gap: 14px;
        width: 100%;
        max-width: 280px
    }

    .step {
        display: flex;
        align-items: center;
        gap: 12px;
        font-size: 14px;
        color: #4a5873;
        transition: color .4s
    }

    .step.on {
        color: #e8edf5
    }

    .step.ok {
        color: #34d399
    }

    .step-dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: #4a5873;
        flex-shrink: 0;
        transition: all .4s
    }

    .step.on .step-dot {
        background: #4e9eff;
        box-shadow: 0 0 8px #4e9eff
    }

    .step.ok .step-dot {
        background: #34d399
    }/* Briefing */
    .brief {
        padding-top: calc(env(safe-area-inset-top, 0px) + 16px)
    }

    .header {
        display: flex;
        align-items: center;
        gap: 12px;
        margin-bottom: 20px
    }

    .back {
        width: 40px;
        height: 40px;
        border-radius: 12px;
        background: #131829;
        border: 1px solid rgba(78, 158, 255, .1);
        color: #7a8ba8;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        flex-shrink: 0
    }

    .back:active {
        background: #1a2035;
        color: #4e9eff
    }

    .route {
        flex: 1
    }

    .route-codes {
        font-size: 22px;
        font-weight: 700
    }

    .route-arrow {
        color: #4a5873;
        margin: 0 6px;
        font-weight: 400
    }

    .route-sub {
        font-size: 13px;
        color: #7a8ba8;
        margin-top: 3px
    }

    .badge {
        padding: 6px 14px;
        background: rgba(78, 158, 255, .08);
        border: 1px solid rgba(78, 158, 255, .2);
        border-radius: 100px;
        font-family: 'SF Mono', Menlo, monospace;
        font-size: 13px;
        color: #4e9eff;
        font-weight: 500
    }

    .live {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 4px 10px;
        background: rgba(52, 211, 153, .1);
        border: 1px solid rgba(52, 211, 153, .2);
        border-radius: 100px;
        font-size: 11px;
        color: #34d399;
        font-weight: 500;
        margin-bottom: 16px
    }

    .live-dot {
        width: 6px;
        height: 6px;
        background: #34d399;
        border-radius: 50%;
        animation: pulse 2s infinite
    }

    @keyframes pulse {
        0%, 100% {
            opacity:1
        }

        50% {
            opacity: .4
        }
    }/* Tabs */
    .tabs {
        display: flex;
        gap: 4px;
        background: #0d1220;
        border-radius: 12px;
        padding: 4px;
        margin-bottom: 20px
    }

    .tab {
        flex: 1;
        padding: 12px 8px;
        border: none;
        border-radius: 10px;
        font-family: -apple-system, sans-serif;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        background: transparent;
        color: #4a5873;
        transition: all .25s
    }

    .tab.on {
        background: #131829;
        color: #e8edf5;
        box-shadow: 0 2px 8px rgba(0, 0, 0, .3)
    }

    .pane {
        display: none
    }

    .pane.on {
        display: block
    }/* Cards */
    .card {
        background: #131829;
        border: 1px solid rgba(78, 158, 255, .1);
        border-radius: 16px;
        padding: 20px;
        margin-bottom: 16px
    }

    .card-title {
        display: flex;
        align-items: center;
        gap: 10px;
        font-size: 13px;
        font-weight: 600;
        color: #7a8ba8;
        text-transform: uppercase;
        letter-spacing: .8px;
        margin-bottom: 14px
    }

    .narr {
        font-size: 16px;
        line-height: 1.75
    }

    .hc {
        color: #a78bfa;
        font-weight: 500
    }

    .hg {
        color: #34d399;
        font-weight: 500
    }

    .hw {
        color: #fbbf24;
        font-weight: 500
    }

    .hi {
        color: #4e9eff;
        font-weight: 500
    }

    .he {
        color: #fb923c;
        font-weight: 500
    }/* Safety */
    .safety {
        background: rgba(52, 211, 153, .06);
        border: 1px solid rgba(52, 211, 153, .15);
        border-radius: 16px;
        padding: 16px 20px;
        margin-bottom: 16px;
        display: flex;
        align-items: flex-start;
        gap: 12px
    }

    .safety-text {
        font-size: 14px;
        color: #34d399;
        line-height: 1.6
    }/* Timeline */
    .tl-item {
        display: flex;
        gap: 14px;
        padding-bottom: 20px;
        position: relative
    }

    .tl-item:last-child {
        padding-bottom: 0
    }

    .tl-left {
        display: flex;
        flex-direction: column;
        align-items: center;
        width: 44px;
        flex-shrink: 0
    }

    .tl-time {
        font-family: 'SF Mono', Menlo, monospace;
        font-size: 11px;
        color: #4a5873;
        margin-bottom: 8px;
        white-space: nowrap
    }

    .tl-dot {
        width: 10px;
        height: 10px;
        border-radius: 50%;
        flex-shrink: 0;
        z-index: 1
    }

    .tl-dot-acc {
        background: #4e9eff
    }

    .tl-dot-cld {
        background: #a78bfa
    }

    .tl-dot-ok {
        background: #34d399
    }

    .tl-dot-wrn {
        background: #fbbf24
    }

    .tl-dot-ev {
        background: #fb923c
    }

    .tl-line {
        width: 2px;
        flex: 1;
        background: rgba(78, 158, 255, .1);
        margin-top: 6px
    }

    .tl-right {
        flex: 1
    }

    .tl-title {
        font-size: 14px;
        font-weight: 600;
        margin-bottom: 4px
    }

    .tl-desc {
        font-size: 13px;
        color: #7a8ba8;
        line-height: 1.5
    }

    .tl-safe {
        font-size: 12px;
        color: #34d399;
        margin-top: 4px;
        font-style: italic
    }/* Cloud bars */
    .cv-row {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 8px 0;
        border-bottom: 1px solid rgba(78, 158, 255, .1)
    }

    .cv-row:last-child {
        border-bottom: none
    }

    .cv-alt {
        font-family: 'SF Mono', Menlo, monospace;
        font-size: 11px;
        color: #4a5873;
        width: 58px;
        text-align: right
    }

    .cv-wrap {
        flex: 1;
        height: 8px;
        background: rgba(255, 255, 255, .05);
        border-radius: 4px;
        overflow: hidden
    }

    .cv-bar {
        height: 100%;
        border-radius: 4px
    }

    .cv-bar-cld {
        background: #a78bfa
    }

    .cv-bar-ok {
        background: #34d399
    }

    .cv-pct {
        font-size: 12px;
        color: #7a8ba8;
        width: 40px
    }/* Conditions */
    .cond-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 12px
    }

    .cond-box {
        background: #0a0e1a;
        border-radius: 10px;
        padding: 14px;
        text-align: center
    }

    .cond-val {
        font-size: 22px;
        font-weight: 700;
        margin-bottom: 4px
    }

    .cond-lbl {
        font-size: 11px;
        color: #7a8ba8;
        text-transform: uppercase;
        letter-spacing: .5px
    }

    .turb-bar {
        height: 8px;
        border-radius: 4px;
        background: #0a0e1a;
        overflow: hidden;
        margin-top: 12px;
        margin-bottom: 6px
    }

    .turb-fill {
        height: 100%;
        border-radius: 4px;
        width: 20%;
        background: #34d399
    }

    .turb-label {
        font-size: 12px;
        color: #7a8ba8;
        display: flex;
        justify-content: space-between
    }/* Animations */
    .fi {
        animation: fadeUp .5s ease both
    }

    @keyframes fadeUp {
        from {
            opacity: 0;
            transform:translateY(16px)
        }

        to {
            opacity: 1;
            transform: translateY(0)
        }
    }

    .spacer {
        height: 40px
    }
    </style>
</head>
<body>
    <div class="app">

        <!-- ====== SEARCH ====== -->
        <div id="S1" class="scr search">
            <div class="logo">
                <div class="logo-box">
                    <svg viewBox="0 0 24 24">
                        <path d="M21 16v-2l-8-5V3.5A1.5 1.5 0 0 0 11.5 2 1.5 1.5 0 0 0 10 3.5V9l-8 5v2l8-2.5V19l-2 1.5V22l3.5-1 3.5 1v-1.5L13 19v-5.5l8 2.5z"/>
                    </svg>
                </div>
                <h1>MyFlight</h1>
                <p>Tu copiloto narrativo. Sabe lo que vas a sentir antes de despegar.</p>
            </div>
            <div>
                <div class="field-group">
                    <label class="field-label">N√∫mero de vuelo</label>
                    <input id="inFlight" class="field" type="text" placeholder="Ej: IB3170" maxlength="10" autocapitalize="characters" autocomplete="off" spellcheck="false">
                </div>
                <div class="field-row">
                    <div class="field-group">
                        <label class="field-label">Fecha</label>
                        <input id="inDate" class="field field-date" type="date">
                    </div>
                    <div class="field-group">
                        <label class="field-label">Tu asiento</label>
                        <input id="inSeat" class="field field-seat" type="text" placeholder="Ej: 14A" maxlength="4" autocapitalize="characters">
                    </div>
                </div>
                <div class="field-group">
                    <label class="field-label">Tipo de avi√≥n</label>
                    <select id="inAC" class="select">
                        <option value="auto">Autom√°tico</option>
                        <option value="A320">Airbus A320</option>
                        <option value="A321">Airbus A321</option>
                        <option value="A320neo">Airbus A320neo</option>
                        <option value="B738">Boeing 737-800</option>
                        <option value="B38M">Boeing 737 MAX</option>
                        <option value="E190">Embraer E190</option>
                    </select>
                </div>
                <div style="height:16px"></div>
                <button class="btn" id="btnGo">Analizar mi vuelo</button>
            </div>
            <div class="examples" style="margin-top:32px">
                <div class="examples-title">Prueba con un ejemplo</div>
                <div class="chips">
                    <span class="chip" data-f="IB3170" data-s="14A">IB3170 MAD‚ÜíFCO</span>
                    <span class="chip" data-f="VY1001" data-s="12F">VY1001 BCN‚ÜíMAD</span>
                    <span class="chip" data-f="BA456" data-s="22A">BA456 LHR‚ÜíMAD</span>
                </div>
            </div>
        </div>

        <!-- ====== LOADING ====== -->
        <div id="S2" class="scr loading off-r">
            <div class="spinner"></div>
            <div style="font-size:18px;font-weight:600">Analizando tu vuelo</div>
            <div class="steps">
                <div class="step" id="st1">
                    <span class="step-dot"></span>
                    Buscando ruta y horarios
                </div>
                <div class="step" id="st2">
                    <span class="step-dot"></span>
                    Consultando capas de nubes
                </div>
                <div class="step" id="st3">
                    <span class="step-dot"></span>
                    Analizando viento y condiciones
                </div>
                <div class="step" id="st4">
                    <span class="step-dot"></span>
                    Prediciendo pista y aproximaci√≥n
                </div>
                <div class="step" id="st5">
                    <span class="step-dot"></span>
                    Preparando tu briefing
                </div>
            </div>
        </div>

        <!-- ====== BRIEFING ====== -->
        <div id="S3" class="scr brief off-r">
            <div id="OUT"></div>
            <div class="spacer"></div>
        </div>

    </div>
    <script>
    // ============================================================
    // DATA
    // ============================================================
    var AP = {
        MAD: {
            name: "Madrid Barajas",
            city: "Madrid",
            lat: 40.4722,
            lon: -3.5608,
            taxi: 12,
            dep: function(wd, ws) {
                return (wd > 90 && wd < 270 && ws > 8) ? {
                    id: "14L",
                    h: 144
                } : {
                    id: "36L",
                    h: 3
                };
            },
            arr: function(wd, ws) {
                return (wd > 90 && wd < 270 && ws > 8) ? {
                    id: "18R",
                    h: 183
                } : {
                    id: "32L",
                    h: 324
                };
            }
        },
        BCN: {
            name: "Barcelona El Prat",
            city: "Barcelona",
            lat: 41.2974,
            lon: 2.0833,
            taxi: 8,
            dep: function(wd, ws) {
                return ((wd > 180 && wd < 360) || wd < 10) ? {
                    id: "07R",
                    h: 74
                } : {
                    id: "25L",
                    h: 254
                };
            },
            arr: function(wd, ws) {
                return ((wd > 180 && wd < 360) || wd < 10) ? {
                    id: "07L",
                    h: 70
                } : {
                    id: "25R",
                    h: 250
                };
            }
        },
        FCO: {
            name: "Roma Fiumicino",
            city: "Roma",
            lat: 41.8003,
            lon: 12.2389,
            taxi: 10,
            dep: function(wd, ws) {
                return (wd > 270 || wd < 90) ? {
                    id: "34L",
                    h: 343
                } : {
                    id: "16R",
                    h: 163
                };
            },
            arr: function(wd, ws) {
                return (wd > 270 || wd < 90) ? {
                    id: "34R",
                    h: 343
                } : {
                    id: "16L",
                    h: 163
                };
            }
        },
        LHR: {
            name: "London Heathrow",
            city: "Londres",
            lat: 51.47,
            lon: -0.4543,
            taxi: 15,
            dep: function(wd, ws) {
                return (wd > 180 && wd < 360) ? {
                    id: "09R",
                    h: 92
                } : {
                    id: "27L",
                    h: 272
                };
            },
            arr: function(wd, ws) {
                return (wd > 180 && wd < 360) ? {
                    id: "09L",
                    h: 92
                } : {
                    id: "27R",
                    h: 272
                };
            }
        },
        STN: {
            name: "London Stansted",
            city: "Londres",
            lat: 51.885,
            lon: 0.235,
            taxi: 7,
            dep: function(wd, ws) {
                return (wd > 100 && wd < 280) ? {
                    id: "22",
                    h: 220
                } : {
                    id: "04",
                    h: 40
                };
            },
            arr: function(wd, ws) {
                return (wd > 100 && wd < 280) ? {
                    id: "22",
                    h: 220
                } : {
                    id: "04",
                    h: 40
                };
            }
        },
        LIS: {
            name: "Lisboa Portela",
            city: "Lisboa",
            lat: 38.7756,
            lon: -9.1354,
            taxi: 8,
            dep: function(wd, ws) {
                return (wd > 120 && wd < 300) ? {
                    id: "21",
                    h: 210
                } : {
                    id: "03",
                    h: 30
                };
            },
            arr: function(wd, ws) {
                return (wd > 120 && wd < 300) ? {
                    id: "21",
                    h: 210
                } : {
                    id: "03",
                    h: 30
                };
            }
        },
    };

    var AC = {
        A320: {
            n: "Airbus A320",
            bark: true
        },
        A321: {
            n: "Airbus A321",
            bark: true
        },
        A320neo: {
            n: "Airbus A320neo",
            bark: true
        },
        A319: {
            n: "Airbus A319",
            bark: true
        },
        B738: {
            n: "Boeing 737-800",
            bark: false
        },
        B38M: {
            n: "Boeing 737 MAX",
            bark: false
        },
        E190: {
            n: "Embraer E190",
            bark: false
        },
    };

    var FLIGHTS = {
        IB3170: {
            al: "Iberia",
            from: "MAD",
            to: "FCO",
            dur: 155,
            ac: "A321",
            fl: 360
        },
        VY1001: {
            al: "Vueling",
            from: "BCN",
            to: "MAD",
            dur: 75,
            ac: "A320",
            fl: 340
        },
        BA456: {
            al: "British Airways",
            from: "LHR",
            to: "MAD",
            dur: 145,
            ac: "A320",
            fl: 370
        },
        FR5994: {
            al: "Ryanair",
            from: "STN",
            to: "MAD",
            dur: 150,
            ac: "B738",
            fl: 360
        },
        IB3100: {
            al: "Iberia",
            from: "MAD",
            to: "LHR",
            dur: 155,
            ac: "A321",
            fl: 380
        },
        TP1024: {
            al: "TAP",
            from: "LIS",
            to: "MAD",
            dur: 75,
            ac: "A320neo",
            fl: 320
        },
    };

    // ============================================================
    // WEATHER SIMULATION
    // ============================================================
    function simWeather(lat) {
        var mo = new Date().getMonth();
        var winter = (mo >= 10 || mo <= 2);
        var med = (lat < 45 && lat > 35);
        var base = med ? (winter ? 12 : 28) : (winter ? 6 : 21);
        var temp = base + Math.round((Math.random() - 0.5) * 6);
        var ws = 5 + Math.round(Math.random() * 18);
        var wd = Math.round(Math.random() * 360);
        var cb = med ? (winter ? 40 : 15) : (winter ? 55 : 30);
        var cL = Math.min(100, Math.max(0, Math.round(cb + (Math.random() - 0.5) * 40)));
        var cM = Math.min(100, Math.max(0, Math.round(cb * 0.7 + (Math.random() - 0.5) * 30)));
        var cH = Math.min(100, Math.max(0, Math.round(cb * 0.4 + (Math.random() - 0.5) * 25)));
        return {
            temp: temp,
            ws: ws,
            wd: wd,
            cL: cL,
            cM: cM,
            cH: cH
        };
    }

    // ============================================================
    // UTILS
    // ============================================================
    function card(h) {
        var d = ['norte', 'noreste', 'este', 'sureste', 'sur', 'suroeste', 'oeste', 'noroeste'];
        return d[Math.round(h / 45) % 8];
    }
    function brg(a, b, c, d) {
        var R = Math.PI / 180;
        var e = R * (d - b);
        var f = Math.sin(e) * Math.cos(R * c);
        var g = Math.cos(R * a) * Math.sin(R * c) - Math.sin(R * a) * Math.cos(R * c) * Math.cos(e);
        return ((Math.atan2(f, g) * 180 / Math.PI) + 360) % 360;
    }
    function ftToM(f) {
        return f * 0.3048;
    }
    function climbAlt(min, cr) {
        if (min >= 12)
            return cr;
        var p = min / 12;
        return cr * (1 - Math.pow(1 - p, 2));
    }

    // ============================================================
    // BRIEFING BUILDER
    // ============================================================
    function makeBriefing(fl, fAP, tAP, seat, acCode) {
        var ac = AC[acCode] || AC[fl.ac];
        var crM = ftToM(fl.fl * 100);
        var dur = fl.dur;

        // Simulate weather at origin & destination
        var oW = simWeather(fAP.lat);
        var dW = simWeather(tAP.lat);

        // Sample cloud along route (7 points)
        var routeClouds = [];
        for (var i = 0; i <= 6; i++) {
            var frac = i / 6;
            var lat = fAP.lat + (tAP.lat - fAP.lat) * frac;
            routeClouds.push({
                frac: frac,
                w: simWeather(lat)
            });
        }

        var depR = fAP.dep(oW.wd, oW.ws);
        var arrR = tAP.arr(dW.wd, dW.ws);
        var rHdg = brg(fAP.lat, fAP.lon, tAP.lat, tAP.lon);

        // Cloud events
        var cEvents = [];
        var wasIn = false;
        for (var j = 0; j < routeClouds.length; j++) {
            var rc = routeClouds[j];
            var min = Math.round(rc.frac * dur);
            var altM;
            if (min < 12)
                altM = climbAlt(min, crM);
            else if (min > dur - 18)
                altM = climbAlt(dur - min, crM);
            else
                altM = crM;

            var inNow = false,
                cTy = '';
            if (altM < 2000 && rc.w.cL > 50) {
                inNow = true;
                cTy = 'baja';
            }
            else if (altM >= 2000 && altM < 6000 && rc.w.cM > 50) {
                inNow = true;
                cTy = 'media';
            }
            else if (altM >= 6000 && altM < 10000 && rc.w.cH > 50) {
                inNow = true;
                cTy = 'alta';
            }

            if (inNow && !wasIn) {
                cEvents.push({
                    t: 'in',
                    min: min,
                    alt: Math.round(altM),
                    ty: cTy
                });
                wasIn = true;
            }
            else if (!inNow && wasIn) {
                cEvents.push({
                    t: 'out',
                    min: min,
                    alt: Math.round(altM)
                });
                wasIn = false;
            }
        }

        // Destination cloud ceiling
        var dcAlt = null;
        if (dW.cL > 40)
            dcAlt = 1500;
        else if (dW.cM > 40)
            dcAlt = 4000;
        var dcMinB = dcAlt ? Math.round(dcAlt / 280) : null;
        var dcMinE = dcAlt && dW.cL > 40 ? Math.round(450 / 280) : null;

        // ---- TU VUELO timeline ----
        var tlV = [];
        tlV.push({
            min: 0,
            icon: 'üõ´',
            c: 'acc',
            title: 'Despegue ‚Äî pista ' + depR.id,
            desc: 'Rumbo ' + card(depR.h) + '. El avi√≥n acelera suavemente y se levanta en 30-40 segundos.',
            re: ''
        });
        tlV.push({
            min: 2,
            icon: '‚úàÔ∏è',
            c: 'acc',
            title: 'Viraje hacia ' + card(rHdg),
            desc: 'El avi√≥n gira suavemente rumbo a ' + tAP.city + '.',
            re: ''
        });

        for (var k = 0; k < cEvents.length; k++) {
            var ce = cEvents[k];
            if (ce.t === 'in') {
                tlV.push({
                    min: ce.min,
                    icon: '‚òÅÔ∏è',
                    c: 'cld',
                    title: 'Entras en las nubes',
                    desc: 'Capa ' + ce.ty + ' a ' + ce.alt.toLocaleString() + 'm. La ventanilla se pone blanca ‚Äî es vapor de agua.',
                    re: 'Las nubes son solo agua condensada. El avi√≥n las atraviesa sin problema.'
                });
            } else {
                tlV.push({
                    min: ce.min,
                    icon: '‚òÄÔ∏è',
                    c: 'ok',
                    title: 'Sales de las nubes',
                    desc: 'Cielo despejado. Altitud: ' + ce.alt.toLocaleString() + 'm.',
                    re: ''
                });
            }
        }

        tlV.push({
            min: 12,
            icon: '‚úàÔ∏è',
            c: 'ok',
            title: 'Crucero ‚Äî FL' + fl.fl,
            desc: (crM / 1000).toFixed(1) + 'km de altitud. Fase m√°s estable y tranquila. Piloto autom√°tico al mando.',
            re: ''
        });
        if (dur > 90)
            tlV.push({
                min: Math.round(dur * 0.35),
                icon: 'üçΩÔ∏è',
                c: 'acc',
                title: 'Servicio a bordo',
                desc: 'Momento para relajarte y disfrutar.',
                re: ''
            });
        tlV.push({
            min: dur - 22,
            icon: 'üì¢',
            c: 'acc',
            title: 'Inicio del descenso',
            desc: 'Los motores suenan m√°s bajo ‚Äî pasan a reposo. Es la forma normal de descender.',
            re: ''
        });

        if (dcMinB) {
            tlV.push({
                min: dur - dcMinB,
                icon: '‚òÅÔ∏è',
                c: 'cld',
                title: 'Entras en nubes (descenso)',
                desc: 'Nubes a ' + dcAlt.toLocaleString() + 'm sobre ' + tAP.city + '. Unos ' + (dcMinB - (dcMinE || 1)) + ' minutos sin ver el suelo.',
                re: 'Los pilotos usan instrumentos de precisi√≥n para aterrizar con seguridad incluso sin ver la pista.'
            });
            if (dcMinE)
                tlV.push({
                    min: dur - dcMinE,
                    icon: 'üëÅÔ∏è',
                    c: 'ok',
                    title: 'Ves el suelo',
                    desc: 'Sales de la nube y ves la pista acerc√°ndose.',
                    re: ''
                });
        }

        tlV.push({
            min: dur,
            icon: 'üõ¨',
            c: 'ok',
            title: 'Aterrizaje ‚Äî pista ' + arrR.id,
            desc: 'Touchdown en ' + tAP.city + '. Luego ~' + tAP.taxi + ' min rodando a terminal.',
            re: ''
        });
        tlV.sort(function(a, b) {
            return a.min - b.min;
        });

        // ---- LO QUE SIEMPRE PASA timeline ----
        var tlA = [];
        tlA.push({
            min: -10,
            icon: 'üîß',
            c: 'ev',
            title: 'Encendido de motores',
            desc: 'Primero se enciende el motor izquierdo, luego el derecho. Los escuchar√°s acelerando suavemente, uno por uno.',
            re: 'Es la secuencia est√°ndar. Siempre se encienden en el mismo orden.'
        });
        if (ac.bark) {
            tlA.push({
                min: -9,
                icon: 'üîä',
                c: 'ev',
                title: '"Barking dog" ‚Äî sonido hidr√°ulico',
                desc: 'Un sonido r√≠tmico, parecido a un ladrido, debajo del avi√≥n. Es el sistema PTU equilibrando presi√≥n hidr√°ulica entre los dos motores.',
                re: 'Solo ocurre en Airbus. Desaparece cuando ambos motores est√°n en marcha. Completamente normal.'
            });
        }
        tlA.push({
            min: -3,
            icon: 'üì¢',
            c: 'acc',
            title: 'Piloto: "Tripulaci√≥n, preparar para despegue"',
            desc: 'El comandante avisa que van a entrar en pista. Las azafatas toman asiento.',
            re: ''
        });
        tlA.push({
            min: 0,
            icon: 'üõ´',
            c: 'acc',
            title: 'Spool up ‚Äî potencia de despegue',
            desc: 'Los motores aceleran. Sentir√°s la aceleraci√≥n empuj√°ndote suavemente al respaldo. En 30-40 segundos el avi√≥n se levanta.',
            re: 'Los motores est√°n dise√±ados para dar mucha m√°s potencia de la necesaria. Siempre hay margen de sobra.'
        });
        tlA.push({
            min: 0.5,
            icon: '‚öôÔ∏è',
            c: 'ev',
            title: 'Gear up ‚Äî las ruedas se guardan',
            desc: 'Unos segundos despu√©s de despegar, escuchar√°s un sonido debajo del avi√≥n. Son las ruedas recogi√©ndose dentro.',
            re: 'Pasa en todos los vuelos. Dura pocos segundos.'
        });
        tlA.push({
            min: 1.5,
            icon: 'üîä',
            c: 'ev',
            title: 'Spool down ‚Äî motores reducen potencia',
            desc: 'Los motores bajan de tono. No se est√°n apagando ‚Äî simplemente ya no hace falta tanta potencia. El avi√≥n sigue subiendo perfectamente.',
            re: 'Es como levantar el pie del acelerador en una cuesta. El avi√≥n sube con menos esfuerzo del que piensas.'
        });
        tlA.push({
            min: 3,
            icon: '‚öôÔ∏è',
            c: 'ev',
            title: 'Flaps se recogen (progresivamente)',
            desc: 'Las piezas del borde del ala se van recogiendo. Puede que oigas un suave zumbido. Si miras por la ventanilla, ver√°s el ala "limpiarse".',
            re: 'Los flaps solo se necesitan a baja velocidad. Al recogerlos, el avi√≥n vuela m√°s eficientemente.'
        });
        tlA.push({
            min: 6,
            icon: 'üîä',
            c: 'ev',
            title: 'Variaciones de potencia en ascenso',
            desc: 'Los motores suben y bajan de intensidad. Esto es normal, sobre todo en espacios a√©reos con mucho tr√°fico.',
            re: 'Cada cambio es una instrucci√≥n del controlador a√©reo o del piloto autom√°tico.'
        });
        tlA.push({
            min: 12,
            icon: 'üîî',
            c: 'ev',
            title: 'Ding ‚Äî se√±al en crucero',
            desc: 'Escuchar√°s un "ding". Dependiendo de la aerol√≠nea, puede ser la se√±al de cinturones o comunicaci√≥n con la tripulaci√≥n.',
            re: 'Los "dings" son el sistema de comunicaci√≥n interno del avi√≥n.'
        });
        tlA.push({
            min: 13,
            icon: 'üîä',
            c: 'ev',
            title: 'Spool down ‚Äî potencia de crucero',
            desc: 'Los motores se estabilizan a potencia menor. El sonido se vuelve constante y suave.',
            re: ''
        });

        var dM = dur > 100 ? dur - 22 : dur - 15;
        tlA.push({
            min: dM,
            icon: 'üîä',
            c: 'ev',
            title: 'Motores casi en reposo (idle)',
            desc: 'Al empezar a bajar, los motores van a potencia m√≠nima. Puede parecer que se apagan ‚Äî no es as√≠. El avi√≥n desciende planeando suavemente.',
            re: 'Un avi√≥n puede planear decenas de kil√≥metros. Los motores siguen funcionando, solo a m√≠nima potencia.'
        });
        tlA.push({
            min: dM + 8,
            icon: '‚öôÔ∏è',
            c: 'ev',
            title: 'Flaps y slats se extienden',
            desc: 'Las piezas del ala se mueven hacia fuera. El avi√≥n necesita ir m√°s lento y los flaps le ayudan.',
            re: ''
        });
        tlA.push({
            min: dM + 10,
            icon: 'üîä',
            c: 'ev',
            title: 'Ajustes de potencia en aproximaci√≥n',
            desc: 'Los motores suben y bajan durante la aproximaci√≥n. El piloto ajusta la velocidad para seguir la senda de descenso perfecta.',
            re: ''
        });
        tlA.push({
            min: dur - 5,
            icon: '‚öôÔ∏è',
            c: 'ev',
            title: 'Gear down ‚Äî las ruedas salen',
            desc: 'Escuchar√°s un sonido debajo del avi√≥n ‚Äî son las ruedas despleg√°ndose para aterrizar. Dura unos segundos.',
            re: 'Este sonido es id√©ntico vuelo tras vuelo. Significa que todo va seg√∫n lo previsto.'
        });
        tlA.push({
            min: dur,
            icon: 'üõ¨',
            c: 'ok',
            title: 'Touchdown',
            desc: 'El avi√≥n toca la pista. Escuchar√°s la reversa de empuje (motores frenan) y ver√°s unas placas levantarse en el ala (spoilers).',
            re: 'Los aviones modernos aterrizan de forma casi autom√°tica.'
        });
        tlA.sort(function(a, b) {
            return a.min - b.min;
        });

        // Narrative
        var narr = 'Vas a despegar probablemente por la <span class="hi">pista ' + depR.id + '</span> con direcci√≥n ' + card(depR.h) + '.';
        narr += ' A los dos minutos, el avi√≥n girar√° suavemente hacia ' + card(rHdg) + ', rumbo a ' + tAP.city + '.';

        if (cEvents.length >= 2) {
            narr += '<br><br>Sobre el <span class="hc">minuto ' + cEvents[0].min + ' entrar√°s en una capa de nubes</span> (' + cEvents[0].ty + ', a ' + cEvents[0].alt.toLocaleString() + 'm). La ventanilla se pondr√° blanca ‚Äî es solo vapor de agua. <span class="hc">Saldr√°s a los ' + cEvents[1].min + ' minutos</span> al superar los ' + cEvents[1].alt.toLocaleString() + 'm.';
        } else if (cEvents.length === 0) {
            narr += '<br><br><span class="hg">No hay nubes significativas en la subida</span> ‚Äî ver√°s el paisaje durante todo el ascenso.';
        }

        narr += '<br><br>En crucero a FL' + fl.fl + ' (' + (crM / 1000).toFixed(0) + 'km) tendr√°s <span class="hg">una fase larga, estable y tranquila</span>. El piloto autom√°tico controla el avi√≥n.';

        narr += '<br><br>Para aterrizar en ' + tAP.city;
        if (dcMinB) {
            narr += ', hay nubes a <span class="hc">' + dcAlt.toLocaleString() + 'm</span>. Entrar√°s en ellas los √∫ltimos ' + dcMinB + ' minutos del descenso';
            if (dcMinE)
                narr += ' y <span class="hc">saldr√°s cuando falten ~' + dcMinE + ' minutos</span> para tocar pista';
            narr += '. Los pilotos tienen instrumentos para aterrizar con precisi√≥n incluso sin ver la pista.';
        } else {
            narr += ' <span class="hg">el cielo est√° bastante despejado</span> ‚Äî podr√°s ver la aproximaci√≥n completa.';
        }
        narr += ' Aterrizar√°s por la <span class="hi">pista ' + arrR.id + '</span>, con ~' + tAP.taxi + ' minutos de rodaje a terminal.';

        // Seat
        var sN = '';
        if (seat && seat.length > 0) {
            var lc = seat.charAt(seat.length - 1).toUpperCase();
            var side = (lc <= 'C') ? 'izquierdo' : 'derecho';
            var vD = (side === 'izquierdo') ? card((rHdg - 90 + 360) % 360) : card((rHdg + 90) % 360);
            sN = 'Est√°s en el <span class="hi">lado ' + side + '</span>. Durante crucero tendr√°s vistas hacia el <span class="hi">' + vD + '</span>.';
        }

        return {
            tlV: tlV,
            tlA: tlA,
            narr: narr,
            sN: sN,
            ac: ac,
            oW: oW,
            dW: dW,
            depR: depR,
            arrR: arrR,
            dur: dur,
            fAP: fAP,
            tAP: tAP,
            fl: fl
        };
    }

    // ============================================================
    // RENDER
    // ============================================================
    function renderTL(items) {
        var h = '';
        for (var i = 0; i < items.length; i++) {
            var t = items[i];
            var last = (i === items.length - 1);
            var dotC = 'tl-dot-acc';
            if (t.c === 'cld')
                dotC = 'tl-dot-cld';
            if (t.c === 'ok')
                dotC = 'tl-dot-ok';
            if (t.c === 'wrn')
                dotC = 'tl-dot-wrn';
            if (t.c === 'ev')
                dotC = 'tl-dot-ev';
            var titleCol = '#4e9eff';
            if (t.c === 'cld')
                titleCol = '#a78bfa';
            if (t.c === 'ok')
                titleCol = '#34d399';
            if (t.c === 'wrn')
                titleCol = '#fbbf24';
            if (t.c === 'ev')
                titleCol = '#fb923c';
            var ml = (t.min < 0) ? Math.abs(t.min) + "' antes" : Math.round(t.min) + ' min';

            h += '<div class="tl-item"><div class="tl-left"><span class="tl-time">' + ml + '</span><span class="tl-dot ' + dotC + '"></span>' + (!last ? '<span class="tl-line"></span>' : '') + '</div>';
            h += '<div class="tl-right"><div class="tl-title" style="color:' + titleCol + '">' + t.icon + ' ' + t.title + '</div><div class="tl-desc">' + t.desc + '</div>';
            if (t.re)
                h += '<div class="tl-safe">‚úì ' + t.re + '</div>';
            h += '</div></div>';
        }
        return h;
    }

    function renderBriefing(b) {
        var code = document.getElementById('inFlight').value;
        var seatV = document.getElementById('inSeat').value || '‚Äî';
        var h = '';

        // Header
        h += '<div class="header fi"><button class="back" id="btnBack"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><path d="M15 18l-6-6 6-6"/></svg></button>';
        h += '<div class="route"><div class="route-codes">' + b.fl.from + '<span class="route-arrow">‚Üí</span>' + b.fl.to + '</div>';
        h += '<div class="route-sub">' + b.fAP.name + ' ‚Üí ' + b.tAP.name + ' ¬∑ ' + Math.floor(b.dur / 60) + 'h ' + (b.dur % 60) + 'min ¬∑ ' + b.ac.n + '</div></div>';
        h += '<span class="badge">' + code + '</span></div>';

        // Badge
        h += '<div class="live fi"><span class="live-dot"></span> Datos meteorol√≥gicos simulados</div>';

        // Tabs
        h += '<div class="tabs fi"><button class="tab on" id="tab0">‚úàÔ∏è Tu vuelo</button><button class="tab" id="tab1">üìñ Lo que siempre pasa</button></div>';

        // === PANE 0: TU VUELO ===
        h += '<div class="pane on" id="p0">';
        h += '<div class="safety"><span style="font-size:20px">üõ°Ô∏è</span><div class="safety-text">Volar es el medio de transporte m√°s seguro. Todo lo que lees aqu√≠ es completamente normal.</div></div>';

        // Narrative
        h += '<div class="card"><div class="card-title">‚úÖ Tu briefing</div><div class="narr">' + b.narr + '</div></div>';

        // Cloud visual
        h += '<div class="card"><div class="card-title">‚òÅÔ∏è Nubes en ' + b.fAP.city + '</div>';
        h += '<div style="background:#0d1220;border-radius:10px;padding:16px">';
        h += '<div class="cv-row"><span class="cv-alt">+6.000m</span><div class="cv-wrap"><div class="cv-bar ' + (b.oW.cH > 40 ? 'cv-bar-cld' : 'cv-bar-ok') + '" style="width:' + b.oW.cH + '%"></div></div><span class="cv-pct">' + b.oW.cH + '%</span></div>';
        h += '<div class="cv-row"><span class="cv-alt">2-6.000m</span><div class="cv-wrap"><div class="cv-bar ' + (b.oW.cM > 40 ? 'cv-bar-cld' : 'cv-bar-ok') + '" style="width:' + b.oW.cM + '%"></div></div><span class="cv-pct">' + b.oW.cM + '%</span></div>';
        h += '<div class="cv-row"><span class="cv-alt">0-2.000m</span><div class="cv-wrap"><div class="cv-bar ' + (b.oW.cL > 40 ? 'cv-bar-cld' : 'cv-bar-ok') + '" style="width:' + b.oW.cL + '%"></div></div><span class="cv-pct">' + b.oW.cL + '%</span></div>';
        h += '</div>';
        h += '<div style="margin-top:12px;font-size:13px;color:#7a8ba8">Tu avi√≥n cruzar√° a FL' + b.fl.fl + ' (~' + (ftToM(b.fl.fl * 100) / 1000).toFixed(0) + 'km), <span class="hg">por encima de todas las capas</span>.</div>';
        h += '</div>';

        // Flight timeline
        h += '<div class="card"><div class="card-title">üïê Timeline de tu vuelo</div>' + renderTL(b.tlV) + '</div>';

        // Conditions
        h += '<div class="card"><div class="card-title">üå°Ô∏è Condiciones</div>';
        h += '<div class="cond-grid">';
        h += '<div class="cond-box"><div class="cond-val" style="color:#34d399">' + b.oW.temp + '¬∞C</div><div class="cond-lbl">' + b.fAP.city + ' ahora</div></div>';
        h += '<div class="cond-box"><div class="cond-val" style="color:#4e9eff">' + b.dW.temp + '¬∞C</div><div class="cond-lbl">' + b.tAP.city + ' llegada</div></div>';
        h += '<div class="cond-box"><div class="cond-val">' + b.oW.ws + ' km/h</div><div class="cond-lbl">Viento ' + b.fl.from + '</div></div>';
        h += '<div class="cond-box"><div class="cond-val">' + b.dW.ws + ' km/h</div><div class="cond-lbl">Viento ' + b.fl.to + '</div></div>';
        h += '</div>';
        h += '<div style="margin-top:16px"><div style="font-size:13px;font-weight:500;margin-bottom:4px">Turbulencia estimada</div>';
        h += '<div class="turb-bar"><div class="turb-fill"></div></div>';
        h += '<div class="turb-label"><span>Baja</span><span style="color:#34d399;font-weight:500">Vuelo tranquilo</span></div></div></div>';

        // Seat
        if (b.sN) {
            h += '<div class="card"><div class="card-title">üëÅÔ∏è Tu ventanilla ¬∑ ' + seatV + '</div><div class="narr">' + b.sN + '</div></div>';
        }
        h += '</div>'; // end pane 0

        // === PANE 1: LO QUE SIEMPRE PASA ===
        h += '<div class="pane" id="p1">';
        h += '<div class="safety"><span style="font-size:20px">üõ°Ô∏è</span><div class="safety-text">Estos sonidos y movimientos ocurren en <strong>todos</strong> los vuelos del mundo. Son se√±al de que todo funciona.</div></div>';
        h += '<div class="card"><div class="card-title">üïê Secuencia completa</div>' + renderTL(b.tlA) + '</div>';

        // Sound guide
        h += '<div class="card"><div class="card-title">üîä Gu√≠a de sonidos ¬∑ ' + b.ac.n + '</div><div class="narr" style="font-size:14px">';
        if (b.ac.bark)
            h += '<span class="he">üîä "Barking dog"</span> ‚Äî Sonido r√≠tmico como un ladrido. Sistema hidr√°ulico PTU. Solo Airbus. Totalmente normal.<br><br>';
        h += '<span class="he">‚öôÔ∏è Gear</span> ‚Äî Sonido mec√°nico al guardar o desplegar ruedas. Breve.<br><br>';
        h += '<span class="he">‚öôÔ∏è Flaps y slats</span> ‚Äî Piezas del ala que se mueven. Zumbido suave.<br><br>';
        h += '<span class="he">‚öôÔ∏è Spoilers</span> ‚Äî Placas en el ala al aterrizar. Las ver√°s por la ventanilla.<br><br>';
        h += '<span class="he">üîä Spool up/down</span> ‚Äî Motores cambiando de intensidad. Nunca se apagan en vuelo.<br><br>';
        h += '<span class="he">üîî Dings</span> ‚Äî Comunicaci√≥n entre pilotos y tripulaci√≥n.';
        h += '</div></div>';
        h += '</div>'; // end pane 1

        document.getElementById('OUT').innerHTML = h;

        // Event listeners for tabs and back
        document.getElementById('btnBack').onclick = goBack;
        document.getElementById('tab0').onclick = function() {
            switchTab(0);
        };
        document.getElementById('tab1').onclick = function() {
            switchTab(1);
        };
    }

    function switchTab(n) {
        document.getElementById('tab0').className = (n === 0) ? 'tab on' : 'tab';
        document.getElementById('tab1').className = (n === 1) ? 'tab on' : 'tab';
        document.getElementById('p0').className = (n === 0) ? 'pane on' : 'pane';
        document.getElementById('p1').className = (n === 1) ? 'pane on' : 'pane';
        document.getElementById('S3').scrollTop = 0;
    }

    // ============================================================
    // NAVIGATION
    // ============================================================
    function showScr(show, hide, dir) {
        document.getElementById(hide).className = 'scr ' + (hide === 'S1' ? 'search' : hide === 'S2' ? 'loading' : 'brief') + (dir === 'f' ? ' off-l' : ' off-r');
        var s = document.getElementById(show);
        s.className = 'scr ' + (show === 'S1' ? 'search' : show === 'S2' ? 'loading' : 'brief');
    }

    function goBack() {
        var steps = ['st1', 'st2', 'st3', 'st4', 'st5'];
        for (var i = 0; i < steps.length; i++) {
            document.getElementById(steps[i]).className = 'step';
        }
        showScr('S1', 'S3', 'b');
        document.getElementById('S2').className = 'scr loading off-r';
    }

    function delay(ms) {
        return new Promise(function(resolve) {
            setTimeout(resolve, ms);
        });
    }

    async function analyze() {
        var code = document.getElementById('inFlight').value.trim().toUpperCase();
        var seat = document.getElementById('inSeat').value.trim().toUpperCase();
        var acSel = document.getElementById('inAC').value;

        if (!code) {
            document.getElementById('inFlight').style.borderColor = '#f87171';
            setTimeout(function() {
                document.getElementById('inFlight').style.borderColor = '';
            }, 1200);
            return;
        }

        var fl = FLIGHTS[code];
        if (!fl) {
            var inp = document.getElementById('inFlight');
            inp.style.borderColor = '#f87171';
            inp.value = '';
            inp.placeholder = 'Prueba: IB3170, VY1001, BA456';
            setTimeout(function() {
                inp.style.borderColor = '';
                inp.placeholder = 'Ej: IB3170';
            }, 3000);
            return;
        }

        var acCode = (acSel !== 'auto') ? acSel : fl.ac;
        var fAP = AP[fl.from];
        var tAP = AP[fl.to];

        showScr('S2', 'S1', 'f');

        var steps = ['st1', 'st2', 'st3', 'st4', 'st5'];
        for (var i = 0; i < steps.length; i++) {
            if (i > 0) {
                document.getElementById(steps[i - 1]).className = 'step ok';
            }
            document.getElementById(steps[i]).className = 'step on';
            await delay(500 + Math.random() * 400);
        }
        document.getElementById(steps[4]).className = 'step ok';
        await delay(300);

        var briefing = makeBriefing(fl, fAP, tAP, seat, acCode);
        renderBriefing(briefing);
        showScr('S3', 'S2', 'f');
    }

    // ============================================================
    // INIT
    // ============================================================
    document.getElementById('inDate').value = new Date().toISOString().split('T')[0];

    document.getElementById('inFlight').addEventListener('input', function() {
        this.value = this.value.toUpperCase().replace(/[^A-Z0-9]/g, '');
    });
    document.getElementById('inSeat').addEventListener('input', function() {
        this.value = this.value.toUpperCase().replace(/[^A-Z0-9]/g, '');
    });

    document.getElementById('btnGo').addEventListener('click', function() {
        analyze();
    });

    var chips = document.querySelectorAll('.chip');
    for (var c = 0; c < chips.length; c++) {
        chips[c].addEventListener('click', function() {
            document.getElementById('inFlight').value = this.getAttribute('data-f');
            document.getElementById('inSeat').value = this.getAttribute('data-s') || '';
        });
    }
    </script>
</body>
</html>

