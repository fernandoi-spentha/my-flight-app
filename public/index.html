<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<title>MyFlight</title>
<style>
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
html,body{height:100%;overflow:hidden}
body{
  font-family:-apple-system,system-ui,'Helvetica Neue',sans-serif;
  background:#0a0e1a;color:#e8edf5;-webkit-font-smoothing:antialiased;
}
.app{height:100%;width:100%;max-width:430px;margin:0 auto;position:relative;overflow:hidden}

/* Screens */
.scr{position:absolute;inset:0;overflow-y:auto;overflow-x:hidden;padding:20px;padding-top:calc(env(safe-area-inset-top,0px) + 20px);padding-bottom:calc(env(safe-area-inset-bottom,0px) + 20px);-webkit-overflow-scrolling:touch;transition:transform .4s ease,opacity .4s ease}
.scr::-webkit-scrollbar{width:0}
.scr.off-r{transform:translateX(100%);opacity:0;pointer-events:none}
.scr.off-l{transform:translateX(-30%);opacity:0;pointer-events:none}

/* Search screen */
.search{display:flex;flex-direction:column;padding-top:calc(env(safe-area-inset-top,0px) + 60px)}
.logo{text-align:center;margin-bottom:48px}
.logo-box{width:72px;height:72px;margin:0 auto 20px;background:linear-gradient(135deg,#4e9eff,#7c3aed);border-radius:22px;display:flex;align-items:center;justify-content:center;box-shadow:0 8px 32px rgba(78,158,255,.25)}
.logo-box svg{width:38px;height:38px;fill:#fff}
.logo h1{font-size:32px;font-weight:700;letter-spacing:-.5px;margin-bottom:8px}
.logo p{font-size:15px;color:#7a8ba8;line-height:1.5;max-width:280px;margin:0 auto}

.field-group{margin-bottom:16px}
.field-label{display:block;font-size:12px;font-weight:600;color:#7a8ba8;text-transform:uppercase;letter-spacing:1px;margin-bottom:8px}
.field{width:100%;padding:16px 18px;background:#0d1220;border:1.5px solid rgba(78,158,255,.1);border-radius:10px;color:#e8edf5;font-family:'SF Mono',Menlo,monospace;font-size:18px;letter-spacing:2px;outline:none;transition:border-color .2s,box-shadow .2s}
.field::placeholder{color:#4a5873;letter-spacing:1px;font-size:15px}
.field:focus{border-color:#4e9eff;box-shadow:0 0 0 4px rgba(78,158,255,.15)}
.field-row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
.field-date{font-family:-apple-system,sans-serif;font-size:15px;letter-spacing:0}
.field-seat{letter-spacing:1px}

.select{width:100%;padding:16px 18px;background:#0d1220;border:1.5px solid rgba(78,158,255,.1);border-radius:10px;color:#e8edf5;font-family:-apple-system,sans-serif;font-size:15px;outline:none;-webkit-appearance:none;appearance:none;background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' fill='%237a8ba8' viewBox='0 0 24 24'%3E%3Cpath d='M7 10l5 5 5-5z'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right 16px center}
.select:focus{border-color:#4e9eff;box-shadow:0 0 0 4px rgba(78,158,255,.15)}

.btn{width:100%;padding:18px;background:linear-gradient(135deg,#4e9eff,#3b82f6);color:#fff;border:none;border-radius:10px;font-family:-apple-system,sans-serif;font-size:16px;font-weight:600;cursor:pointer;transition:transform .15s}
.btn:active{transform:scale(.97)}

.examples{margin-top:auto}
.examples-title{font-size:12px;font-weight:600;color:#4a5873;text-transform:uppercase;letter-spacing:1px;margin-bottom:12px}
.chips{display:flex;flex-wrap:wrap;gap:8px}
.chip{padding:10px 16px;background:#131829;border:1px solid rgba(78,158,255,.1);border-radius:100px;color:#7a8ba8;font-family:'SF Mono',Menlo,monospace;font-size:13px;cursor:pointer}
.chip:active{background:#1a2035;color:#4e9eff}

/* Loading */
.loading{display:flex;flex-direction:column;align-items:center;justify-content:center;text-align:center;gap:32px}
.spinner{width:64px;height:64px;border:3px solid rgba(78,158,255,.1);border-top-color:#4e9eff;border-radius:50%;animation:spin 1s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
.steps{display:flex;flex-direction:column;gap:14px;width:100%;max-width:280px}
.step{display:flex;align-items:center;gap:12px;font-size:14px;color:#4a5873;transition:color .4s}
.step.on{color:#e8edf5}
.step.ok{color:#34d399}
.step-dot{width:8px;height:8px;border-radius:50%;background:#4a5873;flex-shrink:0;transition:all .4s}
.step.on .step-dot{background:#4e9eff;box-shadow:0 0 8px #4e9eff}
.step.ok .step-dot{background:#34d399}

/* Briefing */
.brief{padding-top:calc(env(safe-area-inset-top,0px) + 16px)}
.header{display:flex;align-items:center;gap:12px;margin-bottom:20px}
.back{width:40px;height:40px;border-radius:12px;background:#131829;border:1px solid rgba(78,158,255,.1);color:#7a8ba8;display:flex;align-items:center;justify-content:center;cursor:pointer;flex-shrink:0}
.back:active{background:#1a2035;color:#4e9eff}
.route{flex:1}
.route-codes{font-size:22px;font-weight:700}
.route-arrow{color:#4a5873;margin:0 6px;font-weight:400}
.route-sub{font-size:13px;color:#7a8ba8;margin-top:3px}
.badge{padding:6px 14px;background:rgba(78,158,255,.08);border:1px solid rgba(78,158,255,.2);border-radius:100px;font-family:'SF Mono',Menlo,monospace;font-size:13px;color:#4e9eff;font-weight:500}

.live{display:inline-flex;align-items:center;gap:6px;padding:4px 10px;background:rgba(52,211,153,.1);border:1px solid rgba(52,211,153,.2);border-radius:100px;font-size:11px;color:#34d399;font-weight:500;margin-bottom:16px}
.live-dot{width:6px;height:6px;background:#34d399;border-radius:50%;animation:pulse 2s infinite}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.4}}

/* Tabs */
.tabs{display:flex;gap:4px;background:#0d1220;border-radius:12px;padding:4px;margin-bottom:20px}
.tab{flex:1;padding:12px 8px;border:none;border-radius:10px;font-family:-apple-system,sans-serif;font-size:14px;font-weight:600;cursor:pointer;background:transparent;color:#4a5873;transition:all .25s}
.tab.on{background:#131829;color:#e8edf5;box-shadow:0 2px 8px rgba(0,0,0,.3)}
.pane{display:none}
.pane.on{display:block}

/* Cards */
.card{background:#131829;border:1px solid rgba(78,158,255,.1);border-radius:16px;padding:20px;margin-bottom:16px}
.card-title{display:flex;align-items:center;gap:10px;font-size:13px;font-weight:600;color:#7a8ba8;text-transform:uppercase;letter-spacing:.8px;margin-bottom:14px}
.narr{font-size:16px;line-height:1.75}

.hc{color:#a78bfa;font-weight:500}
.hg{color:#34d399;font-weight:500}
.hw{color:#fbbf24;font-weight:500}
.hi{color:#4e9eff;font-weight:500}
.he{color:#fb923c;font-weight:500}

/* Safety */
.safety{background:rgba(52,211,153,.06);border:1px solid rgba(52,211,153,.15);border-radius:16px;padding:16px 20px;margin-bottom:16px;display:flex;align-items:flex-start;gap:12px}
.safety-text{font-size:14px;color:#34d399;line-height:1.6}

/* Duration box */
.dur-box{background:#0d1220;border-radius:12px;padding:16px 20px;margin-bottom:16px;display:flex;align-items:center;justify-content:space-between}
.dur-label{font-size:13px;color:#7a8ba8;text-transform:uppercase;letter-spacing:.5px}
.dur-val{font-size:22px;font-weight:700;color:#4e9eff}

/* Timeline */
.tl-item{display:flex;gap:14px;padding-bottom:20px;position:relative}
.tl-item:last-child{padding-bottom:0}
.tl-left{display:flex;flex-direction:column;align-items:center;width:44px;flex-shrink:0}
.tl-time{font-family:'SF Mono',Menlo,monospace;font-size:11px;color:#4a5873;margin-bottom:8px;white-space:nowrap}
.tl-dot{width:10px;height:10px;border-radius:50%;flex-shrink:0;z-index:1}
.tl-dot-acc{background:#4e9eff}
.tl-dot-cld{background:#a78bfa}
.tl-dot-ok{background:#34d399}
.tl-dot-wrn{background:#fbbf24}
.tl-dot-ev{background:#fb923c}
.tl-dot-gen{background:#64748b}
.tl-line{width:2px;flex:1;background:rgba(78,158,255,.1);margin-top:6px}
.tl-right{flex:1}
.tl-title{font-size:14px;font-weight:600;margin-bottom:4px}
.tl-desc{font-size:13px;color:#7a8ba8;line-height:1.5}
.tl-safe{font-size:12px;color:#34d399;margin-top:4px;font-style:italic}
.tl-gen{font-size:12px;color:#94a3b8;margin-top:4px;padding:8px 12px;background:rgba(100,116,139,.06);border-radius:8px;border-left:2px solid #334155;line-height:1.5}
.tl-item-gen{margin-left:20px}
.tl-item-gen .tl-title{font-size:13px;font-weight:500}
.tl-item-gen .tl-dot{width:8px;height:8px}
.tl-phase{padding:6px 14px;background:rgba(78,158,255,.06);border:1px solid rgba(78,158,255,.12);border-radius:10px;font-size:12px;font-weight:600;color:#4e9eff;text-transform:uppercase;letter-spacing:.8px;margin-bottom:16px;text-align:center}

/* Cloud bars */
.cv-row{display:flex;align-items:center;gap:12px;padding:8px 0;border-bottom:1px solid rgba(78,158,255,.1)}
.cv-row:last-child{border-bottom:none}
.cv-alt{font-family:'SF Mono',Menlo,monospace;font-size:11px;color:#4a5873;width:58px;text-align:right}
.cv-wrap{flex:1;height:8px;background:rgba(255,255,255,.05);border-radius:4px;overflow:hidden}
.cv-bar{height:100%;border-radius:4px}
.cv-bar-cld{background:#a78bfa}
.cv-bar-ok{background:#34d399}
.cv-pct{font-size:12px;color:#7a8ba8;width:40px}

/* Conditions */
.cond-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
.cond-box{background:#0a0e1a;border-radius:10px;padding:14px;text-align:center}
.cond-val{font-size:22px;font-weight:700;margin-bottom:4px}
.cond-lbl{font-size:11px;color:#7a8ba8;text-transform:uppercase;letter-spacing:.5px}
.turb-bar{height:8px;border-radius:4px;background:#0a0e1a;overflow:hidden;margin-top:12px;margin-bottom:6px}
.turb-fill{height:100%;border-radius:4px;width:20%;background:#34d399}
.turb-label{font-size:12px;color:#7a8ba8;display:flex;justify-content:space-between}

/* Animations */
.fi{animation:fadeUp .5s ease both}
@keyframes fadeUp{from{opacity:0;transform:translateY(16px)}to{opacity:1;transform:translateY(0)}}

.spacer{height:40px}
</style>
</head>
<body>
<div class="app">

<!-- ====== SEARCH ====== -->
<div id="S1" class="scr search">
  <div class="logo">
    <div class="logo-box"><svg viewBox="0 0 24 24"><path d="M21 16v-2l-8-5V3.5A1.5 1.5 0 0 0 11.5 2 1.5 1.5 0 0 0 10 3.5V9l-8 5v2l8-2.5V19l-2 1.5V22l3.5-1 3.5 1v-1.5L13 19v-5.5l8 2.5z"/></svg></div>
    <h1>MyFlight</h1>
    <p>Tu copiloto narrativo. Sabe lo que vas a sentir antes de despegar.</p>
    <p style="font-size:12px;color:#4a5873;margin-top:12px;line-height:1.5;max-width:300px;margin-left:auto;margin-right:auto">Datos reales, contados desde el asiento del pasajero.</p>
  </div>
  <div>
    <div class="field-group"><label class="field-label">N√∫mero de vuelo</label><input id="inFlight" class="field" type="text" placeholder="Ej: IB651" maxlength="10" autocapitalize="characters" autocomplete="off" spellcheck="false"></div>
    <div class="field-row">
      <div class="field-group"><label class="field-label">Fecha</label><input id="inDate" class="field field-date" type="date"></div>
      <div class="field-group"><label class="field-label">Tu asiento</label><input id="inSeat" class="field field-seat" type="text" placeholder="Ej: 14A" maxlength="4" autocapitalize="characters"></div>
    </div>
    <div class="field-group"><label class="field-label">Tipo de avi√≥n</label>
      <select id="inAC" class="select">
        <option value="auto">Autom√°tico</option>
        <option value="A320">Airbus A320</option><option value="A321">Airbus A321</option>
        <option value="A320neo">Airbus A320neo</option><option value="B738">Boeing 737-800</option>
        <option value="B38M">Boeing 737 MAX</option><option value="E190">Embraer E190</option>
      </select>
    </div>
    <div style="height:16px"></div>
    <button class="btn" id="btnGo">Analizar mi vuelo</button>
  </div>
  <div class="examples" style="margin-top:32px">
    <div class="examples-title">Prueba con un ejemplo</div>
    <div class="chips">
      <span class="chip" data-f="IB651" data-s="14A">IB651 MAD‚ÜíFCO</span>
      <span class="chip" data-f="VY1001" data-s="12F">VY1001 BCN‚ÜíMAD</span>
      <span class="chip" data-f="BA456" data-s="22A">BA456 LHR‚ÜíMAD</span>
    </div>
  </div>
</div>

<!-- ====== LOADING ====== -->
<div id="S2" class="scr loading off-r">
  <div class="spinner"></div>
  <div style="font-size:18px;font-weight:600">Analizando tu vuelo</div>
  <div class="steps">
    <div class="step" id="st1"><span class="step-dot"></span>Buscando ruta y horarios</div>
    <div class="step" id="st2"><span class="step-dot"></span>Consultando capas de nubes</div>
    <div class="step" id="st3"><span class="step-dot"></span>Analizando viento y condiciones</div>
    <div class="step" id="st4"><span class="step-dot"></span>Prediciendo pista y aproximaci√≥n</div>
    <div class="step" id="st5"><span class="step-dot"></span>Preparando tu briefing</div>
  </div>
</div>

<!-- ====== BRIEFING ====== -->
<div id="S3" class="scr brief off-r">
  <div id="OUT"></div>
  <div class="spacer"></div>
</div>

</div>
<script>
// ============================================================
// DATA
// ============================================================
var AP = {
  MAD:{name:"Madrid Barajas",city:"Madrid",lat:40.4722,lon:-3.5608,taxi:12,
    dep:function(wd,ws){return(wd>90&&wd<270&&ws>8)?{id:"14L",h:144}:{id:"36L",h:3};},
    arr:function(wd,ws){return(wd>90&&wd<270&&ws>8)?{id:"18R",h:183}:{id:"32L",h:324};}},
  BCN:{name:"Barcelona El Prat",city:"Barcelona",lat:41.2974,lon:2.0833,taxi:8,
    dep:function(wd,ws){return((wd>180&&wd<360)||wd<10)?{id:"07R",h:74}:{id:"25L",h:254};},
    arr:function(wd,ws){return((wd>180&&wd<360)||wd<10)?{id:"07L",h:70}:{id:"25R",h:250};}},
  FCO:{name:"Roma Fiumicino",city:"Roma",lat:41.8003,lon:12.2389,taxi:10,
    dep:function(wd,ws){return(wd>270||wd<90)?{id:"34L",h:343}:{id:"16R",h:163};},
    arr:function(wd,ws){return(wd>270||wd<90)?{id:"34R",h:343}:{id:"16L",h:163};}},
  LHR:{name:"London Heathrow",city:"Londres",lat:51.47,lon:-0.4543,taxi:15,
    dep:function(wd,ws){return(wd>180&&wd<360)?{id:"09R",h:92}:{id:"27L",h:272};},
    arr:function(wd,ws){return(wd>180&&wd<360)?{id:"09L",h:92}:{id:"27R",h:272};}},
  STN:{name:"London Stansted",city:"Londres",lat:51.885,lon:0.235,taxi:7,
    dep:function(wd,ws){return(wd>100&&wd<280)?{id:"22",h:220}:{id:"04",h:40};},
    arr:function(wd,ws){return(wd>100&&wd<280)?{id:"22",h:220}:{id:"04",h:40};}},
  LIS:{name:"Lisboa Portela",city:"Lisboa",lat:38.7756,lon:-9.1354,taxi:8,
    dep:function(wd,ws){return(wd>120&&wd<300)?{id:"21",h:210}:{id:"03",h:30};},
    arr:function(wd,ws){return(wd>120&&wd<300)?{id:"21",h:210}:{id:"03",h:30};}},
};

var AC = {
  A320:{n:"Airbus A320",bark:true,quad:false},A321:{n:"Airbus A321",bark:true,quad:false},
  A320neo:{n:"Airbus A320neo",bark:true,quad:false},A319:{n:"Airbus A319",bark:true,quad:false},
  A330:{n:"Airbus A330",bark:true,quad:false},A350:{n:"Airbus A350",bark:false,quad:false},
  A380:{n:"Airbus A380",bark:true,quad:true},
  B738:{n:"Boeing 737-800",bark:false,quad:false},B38M:{n:"Boeing 737 MAX",bark:false,quad:false},
  B787:{n:"Boeing 787 Dreamliner",bark:false,quad:false},B777:{n:"Boeing 777",bark:false,quad:false},
  B747:{n:"Boeing 747",bark:false,quad:true},
  E190:{n:"Embraer E190",bark:false,quad:false},E195:{n:"Embraer E195",bark:false,quad:false},
  ATR:{n:"ATR 72",bark:false,quad:false},CRJ:{n:"CRJ",bark:false,quad:false},
};

var FLIGHTS = {
  IB651:{al:"Iberia",from:"MAD",to:"FCO",dur:155,ac:"A321",fl:360},
  VY1001:{al:"Vueling",from:"BCN",to:"MAD",dur:75,ac:"A320",fl:340},
  BA456:{al:"British Airways",from:"LHR",to:"MAD",dur:145,ac:"A320",fl:370},
  FR5994:{al:"Ryanair",from:"STN",to:"MAD",dur:150,ac:"B738",fl:360},
  IB3100:{al:"Iberia",from:"MAD",to:"LHR",dur:155,ac:"A321",fl:380},
  TP1024:{al:"TAP",from:"LIS",to:"MAD",dur:75,ac:"A320neo",fl:320},
};

// ============================================================
// WEATHER ‚Äî Open-Meteo (real data)
// ============================================================
function simWeather(lat) {
  // Fallback if API fails
  var mo = new Date().getMonth();
  var winter = (mo >= 10 || mo <= 2);
  var med = (lat < 45 && lat > 35);
  var base = med ? (winter ? 12 : 28) : (winter ? 6 : 21);
  var temp = base + Math.round((Math.random() - 0.5) * 6);
  var ws = 5 + Math.round(Math.random() * 18);
  var wd = Math.round(Math.random() * 360);
  var cb = med ? (winter ? 40 : 15) : (winter ? 55 : 30);
  var cL = Math.min(100, Math.max(0, Math.round(cb + (Math.random() - 0.5) * 40)));
  var cM = Math.min(100, Math.max(0, Math.round(cb * 0.7 + (Math.random() - 0.5) * 30)));
  var cH = Math.min(100, Math.max(0, Math.round(cb * 0.4 + (Math.random() - 0.5) * 25)));
  return {temp:temp, ws:ws, wd:wd, cL:cL, cM:cM, cH:cH, real:false};
}

async function fetchWeather(lat, lon, targetDate) {
  // targetDate: Date object for when the plane will be at this point
  // If not provided, uses current time
  try {
    var target = targetDate || new Date();
    var targetHour = target.getUTCHours();

    // Need forecast_days=2 in case flight crosses midnight
    var url = 'https://api.open-meteo.com/v1/forecast?latitude=' + lat + '&longitude=' + lon
      + '&current=temperature_2m,wind_speed_10m,wind_direction_10m,cloud_cover'
      + '&hourly=cloud_cover_1000hPa,cloud_cover_925hPa,cloud_cover_850hPa,cloud_cover_700hPa,cloud_cover_600hPa,cloud_cover_500hPa,cloud_cover_400hPa,cloud_cover_300hPa,cloud_cover_250hPa,cloud_cover_200hPa,cape,lifted_index,windspeed_300hPa,windspeed_250hPa,windspeed_200hPa,windspeed_500hPa,windspeed_700hPa,windspeed_850hPa'
      + '&forecast_days=2&timezone=UTC';
    var r = await fetch(url);
    if (!r.ok) throw new Error('HTTP ' + r.status);
    var d = await r.json();
    var c = d.current;
    var h = d.hourly;

    // Find the hourly index that best matches the target time
    // hourly.time[] is array of ISO strings like "2026-02-12T00:00"
    var bestIdx = 0;
    if (h.time && h.time.length > 0) {
      var targetMs = target.getTime();
      var minDiff = Infinity;
      for (var ti = 0; ti < h.time.length; ti++) {
        var diff = Math.abs(new Date(h.time[ti] + 'Z').getTime() - targetMs);
        if (diff < minDiff) { minDiff = diff; bestIdx = ti; }
      }
    }

    // Build vertical cloud profile from pressure levels at the target hour
    var profile = [
      {hPa:1000, altM:100,   altFt:300,    cover: h.cloud_cover_1000hPa[bestIdx]},
      {hPa:925,  altM:750,   altFt:2500,   cover: h.cloud_cover_925hPa[bestIdx]},
      {hPa:850,  altM:1500,  altFt:5000,   cover: h.cloud_cover_850hPa[bestIdx]},
      {hPa:700,  altM:3000,  altFt:10000,  cover: h.cloud_cover_700hPa[bestIdx]},
      {hPa:600,  altM:4200,  altFt:14000,  cover: h.cloud_cover_600hPa[bestIdx]},
      {hPa:500,  altM:5500,  altFt:18000,  cover: h.cloud_cover_500hPa[bestIdx]},
      {hPa:400,  altM:7200,  altFt:24000,  cover: h.cloud_cover_400hPa[bestIdx]},
      {hPa:300,  altM:9200,  altFt:30000,  cover: h.cloud_cover_300hPa[bestIdx]},
      {hPa:250,  altM:10400, altFt:34000,  cover: h.cloud_cover_250hPa[bestIdx]},
      {hPa:200,  altM:11800, altFt:39000,  cover: h.cloud_cover_200hPa[bestIdx]}
    ];

    // Derive low/mid/high for legacy compatibility
    var cL = Math.max(profile[0].cover, profile[1].cover, profile[2].cover);
    var cM = Math.max(profile[3].cover, profile[4].cover, profile[5].cover);
    var cH = Math.max(profile[6].cover, profile[7].cover, profile[8].cover, profile[9].cover);

    // CAPE and wind data for turbulence estimation
    var cape = (h.cape && h.cape[bestIdx] != null) ? h.cape[bestIdx] : 0;
    var liftedIdx = (h.lifted_index && h.lifted_index[bestIdx] != null) ? h.lifted_index[bestIdx] : 0;

    // Wind shear: difference between upper and lower level winds
    // High shear at cruise altitude = CAT indicator
    var ws300 = (h.windspeed_300hPa && h.windspeed_300hPa[bestIdx]) || 0;
    var ws250 = (h.windspeed_250hPa && h.windspeed_250hPa[bestIdx]) || 0;
    var ws200 = (h.windspeed_200hPa && h.windspeed_200hPa[bestIdx]) || 0;
    var ws500 = (h.windspeed_500hPa && h.windspeed_500hPa[bestIdx]) || 0;
    var ws700 = (h.windspeed_700hPa && h.windspeed_700hPa[bestIdx]) || 0;
    var ws850 = (h.windspeed_850hPa && h.windspeed_850hPa[bestIdx]) || 0;
    // Shear between 500hPa (5.5km) and 300hPa (9.2km) ‚Äî cruise layer
    var cruiseShear = Math.abs(ws300 - ws500);
    // Max wind at cruise levels
    var cruiseWind = Math.max(ws300, ws250, ws200);

    return {
      temp: Math.round(c.temperature_2m),
      ws: Math.round(c.wind_speed_10m),
      wd: Math.round(c.wind_direction_10m),
      cL: Math.round(cL),
      cM: Math.round(cM),
      cH: Math.round(cH),
      profile: profile,
      real: true,
      forecastHour: h.time[bestIdx],
      cape: Math.round(cape),
      liftedIdx: Math.round(liftedIdx),
      cruiseShear: Math.round(cruiseShear),
      cruiseWind: Math.round(cruiseWind),
      lowWind: Math.round(ws850)
    };
  } catch(e) {
    console.log('Weather API error for', lat, lon, e);
    return simWeather(lat);
  }
}

async function fetchRouteWeather(fAP, tAP, depTimeStr, durationMin) {
  // Calculate when the plane passes each point
  var depUTC = new Date();
  if (depTimeStr) {
    var parsed = new Date(depTimeStr);
    if (!isNaN(parsed.getTime())) depUTC = parsed;
  }
  var dur = durationMin || 150;
  var durMs = dur * 60000;

  // Dynamic sampling: one point every ~15 min, minimum 4, max 20
  var numPoints = Math.max(4, Math.min(20, Math.round(dur / 15)));
  var points = [];
  for (var i = 0; i <= numPoints; i++) {
    var frac = i / numPoints;
    var lat = fAP.lat + (tAP.lat - fAP.lat) * frac;
    var lon = fAP.lon + (tAP.lon - fAP.lon) * frac;
    var passTime = new Date(depUTC.getTime() + frac * durMs);
    points.push({frac: frac, lat: lat, lon: lon, passTime: passTime});
  }

  // Fetch all in parallel, each with its own target time
  var promises = points.map(function(p) { return fetchWeather(p.lat, p.lon, p.passTime); });
  var results = await Promise.all(promises);
  var routeW = [];
  for (var j = 0; j < points.length; j++) {
    routeW.push({frac: points[j].frac, w: results[j]});
  }
  return {
    origin: results[0],
    destination: results[results.length - 1],
    route: routeW
  };
}

// ============================================================
// UTILS
// ============================================================
function card(h){var d=['norte','noreste','este','sureste','sur','suroeste','oeste','noroeste'];return d[Math.round(h/45)%8];}
function brg(a,b,c,d){var R=Math.PI/180;var e=R*(d-b);var f=Math.sin(e)*Math.cos(R*c);var g=Math.cos(R*a)*Math.sin(R*c)-Math.sin(R*a)*Math.cos(R*c)*Math.cos(e);return((Math.atan2(f,g)*180/Math.PI)+360)%360;}
function ftToM(f){return f*0.3048;}

// FIX #1: Turn direction (izquierda/derecha)
function turnDir(depHdg, routeHdg) {
  var diff = ((routeHdg - depHdg) + 360) % 360;
  return (diff <= 180) ? 'derecha' : 'izquierda';
}

// FIX #4: Realistic climb time based on cruise FL
function climbMinutes(fl) {
  if (fl <= 300) return 18;
  if (fl <= 340) return 20;
  if (fl <= 380) return 23;
  return 25;
}

function climbAlt(min, crM, climbMin) {
  if (min >= climbMin) return crM;
  var p = min / climbMin;
  return crM * (1 - Math.pow(1 - p, 2));
}

// ============================================================
// BRIEFING BUILDER
// ============================================================
function makeBriefing(fl, fAP, tAP, seat, acCode, weatherData) {
  var ac = AC[acCode] || AC[fl.ac] || AC['A320'];
  var cruiseFL = fl.fl || 360;
  var crM = ftToM(cruiseFL * 100);
  var dur = fl.dur;
  var climbMin = climbMinutes(cruiseFL);

  // Use real weather data or fallback to simulated
  var oW = weatherData ? weatherData.origin : simWeather(fAP.lat);
  var dW = weatherData ? weatherData.destination : simWeather(tAP.lat);
  var isRealWeather = weatherData && oW.real;

  // Route clouds from real data or simulated
  var routeClouds = [];
  if (weatherData && weatherData.route) {
    routeClouds = weatherData.route;
  } else {
    for (var i = 0; i <= 6; i++) {
      var frac = i / 6;
      var lat = fAP.lat + (tAP.lat - fAP.lat) * frac;
      routeClouds.push({frac: frac, w: simWeather(lat)});
    }
  }

  var depR = fAP.dep(oW.wd, oW.ws);
  var arrR = tAP.arr(dW.wd, dW.ws);
  var rHdg = brg(fAP.lat, fAP.lon, tAP.lat, tAP.lon);

  // FIX #1: Get turn direction
  var tDir = turnDir(depR.h, rHdg);

  // ---- CLOUD LAYERS from vertical profile ----
  // We use origin profile for climb and destination profile for descent
  // For each, detect contiguous cloud layers (cover > 30%)
  function detectCloudLayers(profile) {
    if (!profile) return [];
    var layers = [];
    var inCloud = false;
    var base = 0, top = 0, maxCov = 0;
    for (var i = 0; i < profile.length; i++) {
      var p = profile[i];
      if (p.cover > 30) {
        if (!inCloud) {
          inCloud = true;
          base = p.altM;
          maxCov = p.cover;
        }
        top = p.altM;
        if (p.cover > maxCov) maxCov = p.cover;
      } else {
        if (inCloud) {
          layers.push({baseM: base, topM: top, baseFt: Math.round(base*3.281), topFt: Math.round(top*3.281), maxCover: maxCov, thick: (maxCov > 60)});
          inCloud = false;
        }
      }
    }
    if (inCloud) {
      layers.push({baseM: base, topM: top, baseFt: Math.round(base*3.281), topFt: Math.round(top*3.281), maxCover: maxCov, thick: (maxCov > 60)});
    }
    return layers;
  }

  var originLayers = detectCloudLayers(oW.profile);
  var destLayers = detectCloudLayers(dW.profile);

  // Convert cloud layers to timeline events during climb (origin) and descent (dest)
  // Climb: altitude as function of time
  function altAtMin(min) {
    if (min <= 0) return 0;
    if (min < climbMin) return climbAlt(min, crM, climbMin);
    if (min > dur - 18) {
      var descMin = dur - min;
      return climbAlt(descMin, crM, climbMin);
    }
    return crM;
  }
  function minAtAlt(altM, phase) {
    // phase: 'climb' or 'descent'
    if (phase === 'climb') {
      // Inverse of climbAlt: altM = crM * (1 - (1 - min/climbMin)^2)
      // => min = climbMin * (1 - sqrt(1 - altM/crM))
      var ratio = altM / crM;
      if (ratio >= 1) return climbMin;
      return Math.round(climbMin * (1 - Math.sqrt(1 - ratio)));
    } else {
      // Descent: mirror of climb, starts at dur-18
      var ratio2 = altM / crM;
      if (ratio2 >= 1) return dur - 18;
      var descTime = climbMin * (1 - Math.sqrt(1 - ratio2));
      return Math.round(dur - descTime);
    }
  }

  var cEvents = [];
  // Climb cloud events from origin
  for (var ol = 0; ol < originLayers.length; ol++) {
    var lay = originLayers[ol];
    if (lay.topM < crM) { // Only layers below cruise
      var enterMin = minAtAlt(lay.baseM, 'climb');
      var exitMin = minAtAlt(lay.topM, 'climb');
      if (enterMin < climbMin && exitMin > 0) {
        var desc = lay.thick ? 'Capa densa' : 'Capa parcial';
        cEvents.push({t:'in', min:enterMin, alt:lay.baseM, topAlt:lay.topM, cover:lay.maxCover, thick:lay.thick,
          desc: desc + ' (' + lay.maxCover + '%) entre ' + lay.baseM.toLocaleString() + 'm y ' + lay.topM.toLocaleString() + 'm.'});
        cEvents.push({t:'out', min:exitMin, alt:lay.topM});
      }
    }
  }

  // Route cloud events (mid-cruise) from sampled route points
  // Per-phase turbulence analysis ‚Äî now includes CAPE, wind shear, surface wind
  var turbClimb = 0;  // 0-4 scale (0=imperceptible, 1=baja, 2=baja/media, 3=media/fuerte, 4=fuerte)
  var turbCruise = 0;
  var turbDescent = 0;
  var turbCruiseMinStart = null, turbCruiseMinEnd = null;
  var turbReasons = {climb:[], cruise:[], descent:[]};

  // Climb: check origin layers by type + surface wind + CAPE
  // Medium clouds (700-500hPa) = convective turbulence; Low clouds = calm; High = depends on shear
  for (var tc = 0; tc < originLayers.length; tc++) {
    var tcl = originLayers[tc];
    // Check if layer is medium-level (convective, ~3000-5500m)
    var isMedium = (tcl.baseM >= 2000 && tcl.baseM <= 6000);
    if (isMedium) {
      if (tcl.maxCover > 70) { turbClimb = Math.max(turbClimb, 2); turbReasons.climb.push('nubes medias densas en ascenso'); }
      else if (tcl.maxCover > 40) { turbClimb = Math.max(turbClimb, 1); turbReasons.climb.push('nubes medias en ascenso'); }
    } else if (tcl.baseM > 6000) {
      // High clouds ‚Äî mild unless very dense
      if (tcl.maxCover > 70) turbClimb = Math.max(turbClimb, 1);
    }
    // Low clouds (<2000m) = no turbulence contribution
  }
  // Surface wind at origin
  if (oW.ws > 40) { turbClimb = Math.max(turbClimb, 2); turbReasons.climb.push('viento fuerte en superficie'); }
  else if (oW.ws > 25) { turbClimb = Math.max(turbClimb, 1); turbReasons.climb.push('viento moderado en superficie'); }
  // CAPE at origin ‚Äî convective instability during climb
  if (oW.cape > 1500) { turbClimb = Math.max(turbClimb, 3); turbReasons.climb.push('posibles tormentas en la zona'); }
  else if (oW.cape > 800) { turbClimb = Math.max(turbClimb, 2); turbReasons.climb.push('actividad convectiva en la zona'); }

  // Cruise: check each route point ‚Äî FAA-based CAT thresholds
  // Ref: FAA AC 00-30C ‚Äî jet stream >110kt (204 km/h) + vertical shear >6kt/1000ft (~74 km/h over 500-300hPa)
  // Combined: need BOTH high wind AND high shear for significant CAT
  var cruiseReasonSet = {};
  for (var rp = 0; rp < routeClouds.length; rp++) {
    var rc = routeClouds[rp];
    var rpMin = Math.round(rc.frac * dur);
    if (rpMin < 2 || rpMin > dur - 2) continue;
    var planeAlt = altAtMin(rpMin);

    // --- Cloud turbulence at plane altitude ---
    if (rc.w.profile) {
      for (var pl = 0; pl < rc.w.profile.length; pl++) {
        var pLevel = rc.w.profile[pl];
        if (Math.abs(pLevel.altM - planeAlt) < 1500 && pLevel.cover > 30) {
          // Medium-level clouds (3000-6000m) = convective, more turbulent
          var isMedCloud = (pLevel.altM >= 2000 && pLevel.altM <= 6000);
          if (isMedCloud && pLevel.cover > 60) { turbCruise = Math.max(turbCruise, 2); cruiseReasonSet['nubes convectivas'] = true; }
          else if (isMedCloud && pLevel.cover > 30) { turbCruise = Math.max(turbCruise, 1); cruiseReasonSet['nubes'] = true; }
          else if (pLevel.cover > 60) { turbCruise = Math.max(turbCruise, 1); cruiseReasonSet['nubes'] = true; }
          if (turbCruiseMinStart === null) turbCruiseMinStart = rpMin;
          turbCruiseMinEnd = rpMin;
        }
      }
    }

    // --- CAPE along route ‚Äî thunderstorms ---
    if (rc.w.cape > 2000) { turbCruise = Math.max(turbCruise, 3); cruiseReasonSet['tormentas en ruta'] = true; if (turbCruiseMinStart === null) turbCruiseMinStart = rpMin; turbCruiseMinEnd = rpMin; }
    else if (rc.w.cape > 1000) { turbCruise = Math.max(turbCruise, 2); cruiseReasonSet['actividad convectiva'] = true; if (turbCruiseMinStart === null) turbCruiseMinStart = rpMin; turbCruiseMinEnd = rpMin; }

    // --- CAT: Combined wind + shear (FAA-based) ‚Äî only above FL200 (~6000m) ---
    if (planeAlt > 6000) {
      var cWind = rc.w.cruiseWind;  // max wind at 300/250/200 hPa
      var cShear = rc.w.cruiseShear; // shear between 500-300 hPa

      // Level 3 (Media/Fuerte): jet >204 km/h AND shear >100 km/h
      if (cWind > 204 && cShear > 100) {
        turbCruise = Math.max(turbCruise, 3);
        cruiseReasonSet['vientos muy fuertes en altura'] = true;
        if (cWind > 250) cruiseReasonSet['corriente en chorro (jet stream)'] = true;
        if (turbCruiseMinStart === null) turbCruiseMinStart = rpMin;
        turbCruiseMinEnd = rpMin;
      }
      // Level 2 (Baja/Media): jet >204 km/h AND shear >74 km/h (FAA 6kt/1000ft)
      else if (cWind > 204 && cShear > 74) {
        turbCruise = Math.max(turbCruise, 2);
        cruiseReasonSet['vientos fuertes en altura'] = true;
        if (turbCruiseMinStart === null) turbCruiseMinStart = rpMin;
        turbCruiseMinEnd = rpMin;
      }
      // Level 1 (Baja): wind >150 km/h AND shear >40 km/h
      else if (cWind > 150 && cShear > 40) {
        turbCruise = Math.max(turbCruise, 1);
        cruiseReasonSet['viento moderado en altura'] = true;
        if (turbCruiseMinStart === null) turbCruiseMinStart = rpMin;
        turbCruiseMinEnd = rpMin;
      }
    }
  }
  turbReasons.cruise = Object.keys(cruiseReasonSet);
  var routeTurb = (turbCruise > 0);

  // Descent: cloud-type aware + surface wind + CAPE
  // Low clouds (<2000m) = niebla/stratus, no turbulence
  // Medium clouds (2000-6000m) = convective, generates movement
  // High clouds (>6000m) = mild unless combined with shear
  for (var td = 0; td < destLayers.length; td++) {
    var tdl = destLayers[td];
    var isMedDescent = (tdl.baseM >= 2000 && tdl.baseM <= 6000);
    var isHighDescent = (tdl.baseM > 6000);
    if (isMedDescent) {
      if (tdl.maxCover > 70) { turbDescent = Math.max(turbDescent, 2); turbReasons.descent.push('nubes medias densas en descenso'); }
      else if (tdl.maxCover > 40) { turbDescent = Math.max(turbDescent, 1); turbReasons.descent.push('nubes medias en descenso'); }
    } else if (isHighDescent) {
      if (tdl.maxCover > 70) { turbDescent = Math.max(turbDescent, 1); turbReasons.descent.push('nubes altas en descenso'); }
    }
    // Low clouds: no turbulence contribution (niebla, stratus)
  }
  // Surface wind at destination
  if (dW.ws > 40) { turbDescent = Math.max(turbDescent, 2); turbReasons.descent.push('viento fuerte en destino'); }
  else if (dW.ws > 25) { turbDescent = Math.max(turbDescent, 1); turbReasons.descent.push('viento moderado en destino'); }
  // CAPE at destination
  if (dW.cape > 1500) { turbDescent = Math.max(turbDescent, 3); turbReasons.descent.push('posibles tormentas en destino'); }
  else if (dW.cape > 800) { turbDescent = Math.max(turbDescent, 2); turbReasons.descent.push('actividad convectiva en destino'); }

  var turbMax = Math.max(turbClimb, turbCruise, turbDescent);
  var turbPhases = {climb: turbClimb, cruise: turbCruise, descent: turbDescent, max: turbMax, cruiseMinStart: turbCruiseMinStart, cruiseMinEnd: turbCruiseMinEnd, reasons: turbReasons};

  // Destination cloud layers for descent
  var dcEvents = [];
  for (var dl = 0; dl < destLayers.length; dl++) {
    var dlay = destLayers[dl];
    if (dlay.topM < crM) {
      var dEnterMin = minAtAlt(dlay.topM, 'descent');
      var dExitMin = minAtAlt(dlay.baseM, 'descent');
      if (dEnterMin < dur && dExitMin > dur - 18) {
        dcEvents.push({enterMin: dur - dEnterMin, exitMin: dur - dExitMin, baseM: dlay.baseM, topM: dlay.topM, cover: dlay.maxCover, thick: dlay.thick});
      }
    }
  }

  // Turn duration: degrees / 3¬∞/s, rounded to nearest 5s
  var turnDeg = Math.abs(((depR.h - rHdg + 540) % 360) - 180);
  var turnSec = Math.round((turnDeg / 3) / 5) * 5;
  if (turnSec < 10) turnSec = 10;

  // Day or night? Simple check: 7-20h local = day
  var isDaytime = true;
  if (fl.depTime) {
    var depDt = new Date(fl.depTime.replace(/[+-]\d{2}:\d{2}$/, ''));
    var depHr = depDt.getUTCHours();
    isDaytime = (depHr >= 7 && depHr < 20);
  }

  // Helper: cloud visual description based on day/night
  function cloudVisual(thick) {
    if (isDaytime) {
      return thick ? 'Se ver√° todo blanco por la ventanilla.' : 'Entrar√°s y saldr√°s de nubes ‚Äî ver√°s alternarse blanco y cielo.';
    } else {
      return thick ? 'No ver√°s luces fuera, y probablemente una luz brillante cada pocos segundos ‚Äî son los strobes (luces intermitentes de alta intensidad en las alas) reflejando en el agua de las nubes.' : 'Notar√°s que las luces del exterior desaparecen al entrar en las nubes.';
    }
  }

  // Helper: altitude string with meters and feet
  function altStr(m) {
    return m.toLocaleString() + 'm / ' + Math.round(m * 3.281).toLocaleString() + 'ft';
  }

  // ---- UNIFIED TIMELINE ----
  // All events go in one timeline. type:'flight' for this-flight data, type:'always' for generic info
  var tl = [];

  // === PRE-DEPARTURE ===
  tl.push({min:-25, icon:'üö™', c:'acc', type:'flight', title:'Embarque y preparaci√≥n', desc:'Acom√≥date en tu asiento. Cintur√≥n abrochado, m√≥vil en modo avi√≥n. Familiar√≠zate con las medidas de emergencia y sigue siempre las indicaciones de la tripulaci√≥n.'});

  if (ac.bark) {
    tl.push({min:-20, icon:'üîä', c:'ev', type:'always', title:'"Barking dog" ‚Äî sonido hidr√°ulico', desc:'Un sonido r√≠tmico parecido a un ladrido debajo del avi√≥n. Es el sistema PTU equilibrando la presi√≥n hidr√°ulica entre los dos motores. Solo ocurre en Airbus y desaparece cuando ambos motores est√°n en marcha.'});
  }

  tl.push({min:-15, icon:'üîô', c:'acc', type:'always', title:'Push back', desc:'Un veh√≠culo remolcador empuja el avi√≥n hacia atr√°s para separarlo de la puerta de embarque. En cuanto el avi√≥n comience a moverse, escuchar√°s "Tripulaci√≥n, armar puertas y verificar" ("Arms doors and cross-check"), a lo que la tripulaci√≥n responder√° a medida que lo ejecuten en cada puerta.'});

  // Engine start ‚Äî quad vs twin
  var engDesc = ac.quad
    ? 'Se encienden primero los motores izquierdos y despu√©s los derechos. Los escuchar√°s acelerando uno a uno.'
    : 'Se enciende primero el motor izquierdo y despu√©s el derecho. Los escuchar√°s acelerando, uno a uno.';
  tl.push({min:-12, icon:'üîß', c:'ev', type:'always', title:'Encendido de motores', desc:engDesc});

  // De-icing if cold
  if (oW.temp <= 3) {
    tl.push({min:-10, icon:'‚ùÑÔ∏è', c:'ev', type:'flight', title:'Deshielo de las alas', desc:'Como la temperatura exterior es de ' + oW.temp + '¬∞C, es probable que el avi√≥n tenga que parar para el deshielo. Ver√°s c√≥mo echan un l√≠quido (verde o naranja) sobre las alas y el fuselaje. Es un procedimiento habitual y puede a√±adir unos minutos al tiempo en tierra.'});
  }

  tl.push({min:-fAP.taxi, icon:'üõû', c:'acc', type:'flight', title:'Carreteo', desc:'El avi√≥n rueda hasta la pista de despegue. El tiempo var√≠a seg√∫n el tr√°fico y la posici√≥n (en tu caso, un estimado de ' + fAP.taxi + ' minutos).'});

  tl.push({min:-1, icon:'üì¢', c:'acc', type:'always', title:'Entrada en pista', desc:'Var√≠a seg√∫n cada aerol√≠nea, pero los pilotos suelen avisar a la tripulaci√≥n cuando est√°n entrando en pista. Algo como: "Tripulaci√≥n, entrando en pista para despegue". La tripulaci√≥n toma asiento.'});

  // === TAKEOFF ===
  var takeoffDesc = 'Direcci√≥n ' + card(depR.h) + '. Desde que escuchas el avi√≥n acelerar hasta que despega son aproximadamente 40-50 segundos.';
  if (oW.ws > 25) {
    takeoffDesc += ' Con viento de ' + oW.ws + ' km/h, podr√°s sentir c√≥mo el avi√≥n hace peque√±as correcciones laterales, sobre todo de cola: es perfectamente normal, es el tim√≥n adapt√°ndose a la situaci√≥n del viento.';
  }
  tl.push({min:0, icon:'üõ´', c:'acc', type:'flight', title:'Despegue ‚Äî pista ' + depR.id, desc:takeoffDesc});

  tl.push({min:0.7, icon:'‚öôÔ∏è', c:'ev', type:'always', title:'Retracci√≥n del tren de aterrizaje', desc:'Unos segundos despu√©s de despegar escuchar√°s un sonido mec√°nico seguido de un zumbido debajo del avi√≥n. Son las ruedas recogi√©ndose. Dura pocos segundos.'});

  tl.push({min:1, icon:'üîä', c:'ev', type:'always', title:'Reducci√≥n de potencia', desc:'Entre 40 y 60 segundos despu√©s del despegue, notar√°s que los motores suenan menos intensos y parece que el avi√≥n deja de subir. Es completamente normal: simplemente ya no hace falta tanta potencia, y el avi√≥n sube a una tasa m√°s lenta.'});

  tl.push({min:2, icon:'‚úàÔ∏è', c:'acc', type:'always', title:'El avi√≥n toma rumbo', desc:'El avi√≥n girar√° para tomar rumbo hacia ' + tAP.city + '. Notar√°s una ligera inclinaci√≥n durante unos segundos.'});

  tl.push({min:3.5, icon:'‚öôÔ∏è', c:'ev', type:'always', title:'Retracci√≥n de flaps', desc:'Las piezas del borde del ala (flaps/slats) se recogen de forma progresiva. Puedes o√≠r un suave zumbido. Si miras la ventanilla, ver√°s el ala "limpiarse" (ya es una superficie plana, sin elementos que sobresalgan). Ya vuelas m√°s r√°pido y no son necesarios.'});

  tl.push({min:6, icon:'üîä', c:'ev', type:'always', title:'Ascenso escalonado', desc:'Sobre todo en √°reas con mucho tr√°fico a√©reo, puedes sentir c√≥mo el avi√≥n sube por "escalones": sube, se estabiliza, y vuelve a subir. Los motores var√≠an su intensidad con cada cambio. Es la forma habitual de gestionar el ascenso.'});

  // Climb cloud events
  for (var k = 0; k < cEvents.length; k++) {
    var ce = cEvents[k];
    if (ce.t === 'in') {
      var cNarr = 'Capa ' + (ce.thick ? 'densa' : 'parcial') + ' (' + ce.cover + '%, entre ' + altStr(ce.alt) + ' y ' + altStr(ce.topAlt) + '). ' + cloudVisual(ce.thick);
      tl.push({min:ce.min, icon:'‚òÅÔ∏è', c:'cld', type:'flight', title:'Entras en nubes (minuto ' + ce.min + ')', desc:cNarr});
    } else {
      tl.push({min:ce.min, icon:'‚òÄÔ∏è', c:'ok', type:'flight', title:'Sales de las nubes (minuto ' + ce.min + ')', desc:'Cielo despejado a ' + altStr(ce.alt) + '.'});
    }
  }

  // === CRUISE ===
  var cruiseMinRange = climbMin > 20 ? (climbMin - 3) + '-' + climbMin : String(climbMin);
  tl.push({min:climbMin, icon:'‚úàÔ∏è', c:'ok', type:'flight', title:'Altitud de crucero (minuto ~' + cruiseMinRange + ')', desc:'El avi√≥n se estabiliza y los motores reducen potencia.'});

  tl.push({min:10, icon:'üîî', c:'ev', type:'always', title:'Se√±al de cinturones', desc:'Cada aerol√≠nea tiene diferentes est√°ndares para desactivar la se√±al de cinturones. Algunas lo hacen cuando el avi√≥n sube de 10.000 pies (3.000 metros) y otras esperan al crucero. Recuerda que es importante mantenerlos abrochados en todo momento.'});

  tl.push({min:climbMin, icon:'üìã', c:'ev', type:'always', title:'Datos de crucero', desc:'Los aviones comerciales vuelan entre FL300 y FL400 (entre 9.000 y 12.000 metros). Siempre existe una separaci√≥n vertical de 1.000 pies (300 metros) y horizontal con otros aviones. La altura exacta depende de la meteorolog√≠a, el tr√°fico y el plan de vuelo. Durante el vuelo puede variar, por eso sentir√°s que el avi√≥n sube y/o baja ocasionalmente.'});

  // Route clouds at cruise altitude ‚Äî use turbulence data for consistent messaging
  var turbLabelsLC2 = ['imperceptible', 'baja', 'baja/media', 'media/fuerte', 'fuerte'];
  if (routeTurb || turbCruise > 0) {
    var cruiseReasons = turbReasons.cruise;
    var hasCloudsCruise = cruiseReasons.indexOf('nubes') >= 0;
    var nonCloudReasons = cruiseReasons.filter(function(r) { return r !== 'nubes'; });
    var cruiseTlDesc = '';
    if (nonCloudReasons.length > 0) {
      cruiseTlDesc = 'Se prev√© turbulencia ' + turbLabelsLC2[turbCruise] + ' debido a ' + nonCloudReasons.join(' y ') + '.';
    } else if (hasCloudsCruise) {
      cruiseTlDesc = 'Se detectan nubes cerca de la altitud de crucero. Es posible que notes turbulencia ' + turbLabelsLC2[turbCruise] + '.';
    } else {
      cruiseTlDesc = 'Se prev√© turbulencia ' + turbLabelsLC2[turbCruise] + ' en esta fase del vuelo.';
    }
    var cruiseTlTitle = 'Turbulencia prevista en crucero';
    if (turbCruiseMinStart !== null) {
      if (turbCruiseMinStart === turbCruiseMinEnd) cruiseTlTitle += ' (~min ' + turbCruiseMinStart + ')';
      else cruiseTlTitle += ' (min ' + turbCruiseMinStart + '-' + turbCruiseMinEnd + ')';
    }
    tl.push({min: turbCruiseMinStart || (climbMin + 5), icon:'üîî', c:'wrn', type:'flight', title:cruiseTlTitle, desc:cruiseTlDesc});
    tl.push({min:(turbCruiseMinStart || climbMin) + 1, icon:'üõ°Ô∏è', c:'ev', type:'always', title:'Sobre la turbulencia', desc:'Las turbulencias son inc√≥modas pero no suponen ning√∫n peligro para el avi√≥n. Los pilotos est√°n tranquilos en cabina y, si pueden, adaptar√°n la ruta para reducir las molestias. Es importante mantener el cintur√≥n abrochado en todo momento.'});
  } else {
    tl.push({min:climbMin + 5, icon:'‚úàÔ∏è', c:'ok', type:'flight', title:'Crucero sin turbulencias previstas', desc:'No se prev√©n turbulencias a la altura de vuelo.'});
  }

  if (dur > 90) tl.push({min:Math.round(dur*0.35), icon:'üçΩÔ∏è', c:'acc', type:'always', title:'Servicio a bordo', desc:'En alg√∫n momento del crucero, la tripulaci√≥n comenzar√° el servicio de comidas y bebidas. El momento exacto depende de la aerol√≠nea y las condiciones del vuelo.'});

  // === DESCENT ===
  tl.push({min:dur-22, icon:'üì¢', c:'acc', type:'flight', title:'Inicio del descenso', desc:'Los motores reducen su potencia al m√≠nimo y notas c√≥mo el avi√≥n se inclina levemente hacia adelante. Es la forma habitual de iniciar el descenso y la aproximaci√≥n.'});

  tl.push({min:dur-15, icon:'üîä', c:'ev', type:'always', title:'Motores al m√≠nimo', desc:'Al descender, los motores van a potencia m√≠nima y por eso los oyes menos. Sentir√°s que el avi√≥n desciende por escalones, y el sonido de los motores cambia de intensidad.'});

  // Descent cloud events
  for (var dc = 0; dc < dcEvents.length; dc++) {
    var dce = dcEvents[dc];
    var minsLeft = dce.enterMin;
    var minsLeftExit = dce.exitMin;
    var dCloudNarr = 'Capa ' + (dce.thick ? 'densa' : 'parcial') + ' (' + dce.cover + '%, entre ' + altStr(dce.topM) + ' y ' + altStr(dce.baseM) + '). ' + cloudVisual(dce.thick);
    tl.push({min:dur - minsLeft, icon:'‚òÅÔ∏è', c:'cld', type:'flight', title:'Nubes en descenso (faltan ~' + minsLeft + ' min)', desc:dCloudNarr + ' Los pilotos disponen de instrumentos de precisi√≥n para aterrizar con total seguridad incluso sin visibilidad exterior.'});
    if (dce.baseM > 200) {
      tl.push({min:dur - minsLeftExit, icon:'üëÅÔ∏è', c:'ok', type:'flight', title:'Sales de las nubes (faltan ~' + minsLeftExit + ' min)', desc:'Desde que sales de las nubes, quedan aproximadamente ' + minsLeftExit + ' minutos para aterrizar.'});
    }
  }

  tl.push({min:dur-5, icon:'‚öôÔ∏è', c:'ev', type:'always', title:'Flaps desplegados', desc:'Empezar√°s a ver los flaps despleg√°ndose. Lo hacen de forma escalonada, normalmente en dos o tres pasos. En cuanto se despliegan, notar√°s c√≥mo el avi√≥n reduce su velocidad.'});

  tl.push({min:dur-3, icon:'üîä', c:'ev', type:'always', title:'Ajustes de potencia en aproximaci√≥n', desc:'Los motores suben y bajan durante la aproximaci√≥n final. El piloto ajusta la velocidad para seguir la senda de descenso con precisi√≥n.'});

  tl.push({min:dur-2, icon:'‚öôÔ∏è', c:'ev', type:'always', title:'Tren de aterrizaje desplegado', desc:'Escuchar√°s un ruido bajo el avi√≥n: son las ruedas saliendo para el aterrizaje. El sonido dura unos segundos y es id√©ntico en todos los vuelos.'});

  var landDesc = 'Toma de tierra en ' + tAP.city + '. Escuchar√°s la reversa de empuje y ver√°s los spoilers levantarse en el ala. Despu√©s, ~' + tAP.taxi + ' minutos de rodaje hasta la terminal.';
  if (dW.ws > 25) {
    landDesc += ' Con viento de ' + dW.ws + ' km/h en destino, es posible que notes peque√±as correcciones laterales en la aproximaci√≥n final. Los pilotos est√°n perfectamente entrenados para esta situaci√≥n.';
  }
  tl.push({min:dur, icon:'üõ¨', c:'ok', type:'flight', title:'Aterrizaje ‚Äî pista ' + arrR.id, desc:landDesc});

  tl.sort(function(a,b){ return a.min - b.min; });

  // (Old separate "lo que siempre pasa" timeline removed ‚Äî now unified)

  // ---- NARRATIVE ----
  var narr = 'Vas a despegar probablemente por la <span class="hi">pista ' + depR.id + '</span> con direcci√≥n ' + card(depR.h) + '.';
  narr += ' A los pocos minutos, el avi√≥n girar√° para tomar rumbo hacia <span class="hi">' + tAP.city + '</span>.';

  // Climb cloud narrative
  if (originLayers.length > 0) {
    narr += '<br><br>';
    for (var nl = 0; nl < originLayers.length; nl++) {
      var nlay = originLayers[nl];
      var enterT = minAtAlt(nlay.baseM, 'climb');
      var exitT = minAtAlt(nlay.topM, 'climb');
      if (nl > 0) narr += ' ';
      narr += 'Sobre el <span class="hc">minuto ' + enterT + ' entrar√°s en una capa ' + (nlay.thick ? 'densa' : 'parcial') + ' de nubes</span> (' + nlay.maxCover + '%, entre ' + altStr(nlay.baseM) + ' y ' + altStr(nlay.topM) + '). ' + cloudVisual(nlay.thick);
      narr += ' <span class="hc">Saldr√°s sobre el minuto ' + exitT + '</span>.';
    }
  } else {
    narr += '<br><br><span class="hg">No se prev√©n nubes significativas durante el ascenso</span> ‚Äî podr√°s ver el paisaje durante toda la subida.';
  }

  // Cruise
  if (routeTurb) {
    narr += '<br><br>En crucero, es posible que el avi√≥n encuentre <span class="hc">zonas de nubes altas que ocasionen algo de turbulencia</span>.';
  } else {
    narr += '<br><br>Una vez alcanzada la altitud de crucero, <span class="hg">no se prev√©n nubes a la altura de vuelo</span>. Vuelo tranquilo.';
  }

  // Descent
  narr += '<br><br>Para aterrizar en ' + tAP.city;
  if (destLayers.length > 0) {
    narr += ', hay nubes en el descenso:';
    for (var ndl = 0; ndl < destLayers.length; ndl++) {
      var ndlay = destLayers[ndl];
      narr += ' <span class="hc">capa ' + (ndlay.thick ? 'densa' : 'parcial') + ' (' + ndlay.maxCover + '%) entre ' + altStr(ndlay.topM) + ' y ' + altStr(ndlay.baseM) + '</span>';
      if (ndl < destLayers.length - 1) narr += ',';
    }
    narr += '. Los pilotos aterrizan con total normalidad en estas condiciones.';
  } else {
    narr += ' <span class="hg">el cielo est√° despejado</span> ‚Äî podr√°s ver la aproximaci√≥n completa.';
  }
  narr += ' Aterrizar√°s por la <span class="hi">pista ' + arrR.id + '</span>, con aproximadamente ' + tAP.taxi + ' minutos de rodaje hasta la terminal.';

  // Seat
  var sN = '';
  if (seat && seat.length > 0) {
    var lc = seat.charAt(seat.length - 1).toUpperCase();
    var side = (lc <= 'C') ? 'izquierdo' : 'derecho';
    var vD = (side === 'izquierdo') ? card((rHdg - 90 + 360) % 360) : card((rHdg + 90) % 360);
    sN = 'Est√°s en el <span class="hi">lado ' + side + '</span>. Durante crucero tendr√°s vistas hacia el <span class="hi">' + vD + '</span>.';
  }

  // Format departure/arrival times
  var depTimeStr = null, arrTimeStr = null;
  if (fl.depTime) {
    var dt = new Date(fl.depTime.replace(/[+-]\d{2}:\d{2}$/, ''));
    depTimeStr = ('0'+dt.getUTCHours()).slice(-2) + ':' + ('0'+dt.getUTCMinutes()).slice(-2);
  }
  if (fl.arrTime) {
    var at = new Date(fl.arrTime.replace(/[+-]\d{2}:\d{2}$/, ''));
    arrTimeStr = ('0'+at.getUTCHours()).slice(-2) + ':' + ('0'+at.getUTCMinutes()).slice(-2);
  }

  return {tl:tl, narr:narr, sN:sN, ac:ac, oW:oW, dW:dW, depR:depR, arrR:arrR, dur:dur, fAP:fAP, tAP:tAP, fl:fl, isRealWeather:isRealWeather, depTimeStr:depTimeStr, arrTimeStr:arrTimeStr, routeTurb:routeTurb, turbPhases:turbPhases, routeClouds:routeClouds, crM:crM, climbMin:climbMin, altAtMin:altAtMin};
}

// ============================================================
// RENDER
// ============================================================
function renderTL(items, dur) {
  var h = '';
  // Find where descent starts (dur - 22 approx)
  var descentStart = dur ? dur - 22 : 9999;

  for (var i = 0; i < items.length; i++) {
    var t = items[i];
    var last = (i === items.length - 1);
    var isGeneric = (t.type === 'always');

    var dotC = 'tl-dot-acc';
    if (t.c === 'cld') dotC = 'tl-dot-cld';
    if (t.c === 'ok') dotC = 'tl-dot-ok';
    if (t.c === 'wrn') dotC = 'tl-dot-wrn';
    if (t.c === 'ev') dotC = isGeneric ? 'tl-dot-gen' : 'tl-dot-ev';

    var titleCol = '#4e9eff';
    if (t.c === 'cld') titleCol = '#a78bfa';
    if (t.c === 'ok') titleCol = '#34d399';
    if (t.c === 'wrn') titleCol = '#94a3b8';
    if (t.c === 'ev') titleCol = isGeneric ? '#64748b' : '#fb923c';

    var ml;
    if (t.min < 0) ml = Math.abs(t.min) + "' antes";
    else if (t.min < 1) ml = 'Despegue';
    else {
      ml = Math.round(t.min) + ' min';
      // For descent events, also show minutes to arrival
      if (dur && t.min >= descentStart && t.min < dur) {
        var toArr = Math.round(dur - t.min);
        if (toArr > 0) ml += '<br><span style="color:#a78bfa;font-size:10px">-' + toArr + "' aterr.</span>";
      }
    }

    var itemClass = 'tl-item' + (isGeneric ? ' tl-item-gen' : '');
    h += '<div class="' + itemClass + '"><div class="tl-left"><span class="tl-time">' + ml + '</span><span class="tl-dot ' + dotC + '"></span>' + (!last ? '<span class="tl-line"></span>' : '') + '</div>';
    h += '<div class="tl-right"><div class="tl-title" style="color:' + titleCol + '">' + t.icon + ' ' + t.title + '</div>';
    if (isGeneric) {
      h += '<div class="tl-gen">' + t.desc + '</div>';
    } else {
      h += '<div class="tl-desc">' + t.desc + '</div>';
    }
    if (t.re) h += '<div class="tl-safe">‚úì ' + t.re + '</div>';
    h += '</div></div>';
  }
  return h;
}

function renderBriefing(b) {
  var code = document.getElementById('inFlight').value;
  var seatV = document.getElementById('inSeat').value || '‚Äî';
  var h = '';

  // Header
  h += '<div class="header fi"><button class="back" id="btnBack"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><path d="M15 18l-6-6 6-6"/></svg></button>';
  h += '<div class="route"><div class="route-codes">' + b.fl.from + '<span class="route-arrow">‚Üí</span>' + b.fl.to + '</div>';
  h += '<div class="route-sub">' + b.fAP.name + ' ‚Üí ' + b.tAP.name + ' ¬∑ ' + b.ac.n + '</div></div>';
  h += '<span class="badge">' + code + '</span></div>';

  // FIX #5: Duration box with departure/arrival times
  h += '<div class="dur-box fi">';
  if (b.depTimeStr && b.arrTimeStr) {
    h += '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">';
    h += '<div style="text-align:left"><div style="font-size:22px;font-weight:700;color:#e2e8f0">' + b.depTimeStr + '</div><div style="font-size:12px;color:#7a8ba8">' + b.fl.from + ' ¬∑ hora local</div></div>';
    h += '<div style="text-align:center;flex:1;padding:0 12px"><div style="border-top:1px dashed #334155;position:relative;top:0"><span style="position:relative;top:-10px;background:#0f172a;padding:0 8px;font-size:13px;color:#94a3b8">‚úàÔ∏è ' + Math.floor(b.dur/60) + 'h ' + (b.dur%60) + 'min</span></div></div>';
    h += '<div style="text-align:right"><div style="font-size:22px;font-weight:700;color:#e2e8f0">' + b.arrTimeStr + '</div><div style="font-size:12px;color:#7a8ba8">' + b.fl.to + ' ¬∑ hora local</div></div>';
    h += '</div>';
  } else {
    h += '<span class="dur-label">Duraci√≥n media del vuelo</span><span class="dur-val">' + Math.floor(b.dur/60) + 'h ' + (b.dur%60) + 'min</span>';
  }
  h += '</div>';

  // Badge - real or simulated weather
  if (b.isRealWeather) {
    h += '<div class="live fi"><span class="live-dot"></span> Datos meteorol√≥gicos en tiempo real (Open-Meteo)</div>';
  } else {
    h += '<div class="live fi" style="background:rgba(251,191,36,.1);border-color:rgba(251,191,36,.2)"><span class="live-dot" style="background:#fbbf24"></span> <span style="color:#fbbf24">Datos meteorol√≥gicos simulados</span></div>';
  }

  // Turbulence estimate with per-phase breakdown
  var tp = b.turbPhases;
  var turbLabels = ['Imperceptible', 'Baja', 'Baja / Media', 'Media / Fuerte', 'Fuerte'];
  var turbColors = ['#4e9eff', '#7a8ba8', '#94a3b8', '#64748b', '#475569'];
  var turbWidths = ['8%', '25%', '45%', '65%', '85%'];

  h += '<div class="card fi">';
  h += '<div class="card-title">‚úàÔ∏è Turbulencia estimada</div>';
  h += '<div class="turb-bar"><div class="turb-fill" style="width:' + turbWidths[tp.max] + ';background:' + turbColors[tp.max] + '"></div></div>';
  h += '<div style="display:flex;justify-content:space-between;font-size:10px;color:#4a5873;margin-top:4px"><span>Imperceptible</span><span>Baja</span><span>Baja/Media</span><span>Media/Fuerte</span><span>Fuerte</span></div>';
  h += '<div style="text-align:center;margin-top:10px;font-size:15px;font-weight:600;color:' + turbColors[tp.max] + '">' + turbLabels[tp.max] + '</div>';

  // Phase breakdown
  h += '<div style="margin-top:12px;display:flex;gap:8px">';
  h += '<div style="flex:1;background:#0a0e1a;border-radius:8px;padding:10px;text-align:center"><div style="font-size:11px;color:#4a5873;margin-bottom:4px">Ascenso</div><div style="font-size:13px;font-weight:500;color:' + turbColors[tp.climb] + '">' + turbLabels[tp.climb] + '</div></div>';
  h += '<div style="flex:1;background:#0a0e1a;border-radius:8px;padding:10px;text-align:center"><div style="font-size:11px;color:#4a5873;margin-bottom:4px">Crucero</div><div style="font-size:13px;font-weight:500;color:' + turbColors[tp.cruise] + '">' + turbLabels[tp.cruise];
  if (tp.cruiseMinStart !== null && tp.cruise > 0) {
    if (tp.cruiseMinStart === tp.cruiseMinEnd) {
      h += '<div style="font-size:10px;color:#4a5873;margin-top:2px">~min ' + tp.cruiseMinStart + '</div>';
    } else {
      h += '<div style="font-size:10px;color:#4a5873;margin-top:2px">min ' + tp.cruiseMinStart + '-' + tp.cruiseMinEnd + '</div>';
    }
  }
  h += '</div></div>';
  h += '<div style="flex:1;background:#0a0e1a;border-radius:8px;padding:10px;text-align:center"><div style="font-size:11px;color:#4a5873;margin-bottom:4px">Descenso</div><div style="font-size:13px;font-weight:500;color:' + turbColors[tp.descent] + '">' + turbLabels[tp.descent] + '</div></div>';
  h += '</div>';
  // Human-readable turbulence narrative
  var turbNarr = '';
  var turbLabelsLC = ['imperceptible', 'baja', 'baja/media', 'media/fuerte', 'fuerte'];
  // Build narrative per phase
  var phases = [];
  if (tp.climb === 0) {
    phases.push('Durante el ascenso, la turbulencia ser√° imperceptible');
  } else {
    var climbWhy = tp.reasons.climb.length > 0 ? ' debido a ' + tp.reasons.climb.join(' y ') : '';
    phases.push('Durante el ascenso, es probable turbulencia ' + turbLabelsLC[tp.climb] + climbWhy);
  }
  if (tp.cruise > 0 && tp.cruiseMinStart !== null) {
    var cruiseWhy = tp.reasons.cruise.filter(function(r){return r !== 'nubes';});
    var cruiseWhyStr = cruiseWhy.length > 0 ? ' debido a ' + cruiseWhy.join(' y ') : '';
    // Check if in clouds or not at cruise
    var inCloudCruise = false;
    for (var rci = 0; rci < b.routeClouds.length; rci++) {
      var rcw = b.routeClouds[rci];
      if (rcw.w.profile) {
        for (var pli = 0; pli < rcw.w.profile.length; pli++) {
          if (rcw.w.profile[pli].altM >= b.crM - 1500 && rcw.w.profile[pli].altM <= b.crM + 1500 && rcw.w.profile[pli].cover > 30) inCloudCruise = true;
        }
      }
    }
    // Handle same start/end minute
    var cruiseTimeStr;
    if (tp.cruiseMinStart === tp.cruiseMinEnd) {
      cruiseTimeStr = 'Sobre el minuto ' + tp.cruiseMinStart;
    } else {
      cruiseTimeStr = 'Entre el minuto ' + tp.cruiseMinStart + ' y el ' + tp.cruiseMinEnd;
    }
    phases.push(cruiseTimeStr + ', es probable turbulencia ' + turbLabelsLC[tp.cruise] + cruiseWhyStr + '. ' + (inCloudCruise ? 'Estar√°s dentro de nubes en parte de este tramo' : 'No estar√°s dentro de nubes'));
  } else if (tp.cruise > 0) {
    var cruiseWhy2 = tp.reasons.cruise.filter(function(r){return r !== 'nubes';});
    var cruiseWhyStr2 = cruiseWhy2.length > 0 ? ' debido a ' + cruiseWhy2.join(' y ') : '';
    phases.push('Durante el crucero, es probable turbulencia ' + turbLabelsLC[tp.cruise] + cruiseWhyStr2);
  } else {
    phases.push('Durante el crucero, no se prev√© turbulencia');
  }
  if (tp.descent > 0) {
    var descWhy = tp.reasons.descent.length > 0 ? ' debido a ' + tp.reasons.descent.join(' y ') : '';
    phases.push('En el descenso es probable turbulencia ' + turbLabelsLC[tp.descent] + descWhy);
  } else {
    phases.push('El descenso ser√° tranquilo');
  }
  turbNarr = phases.join('. ') + '.';
  if (tp.max > 0) {
    turbNarr += ' Recuerda que las turbulencias son inc√≥modas pero no afectan en absoluto a la seguridad del vuelo.';
  }
  h += '<div style="margin-top:10px;font-size:12px;color:#94a3b8;line-height:1.7">' + turbNarr + '</div>';
  h += '</div>';

  // Safety banner
  h += '<div class="safety fi"><span style="font-size:20px">üõ°Ô∏è</span><div class="safety-text">La aviaci√≥n comercial es el medio de transporte m√°s seguro del mundo. Todo lo que lees aqu√≠ forma parte del funcionamiento normal de <strong>todos</strong> los vuelos.</div></div>';

  // Narrative
  h += '<div class="card fi"><div class="card-title">‚úÖ Tu briefing</div><div class="narr">' + b.narr + '</div></div>';

  // Cloud cross-section chart ‚Äî canvas
  h += '<div class="card fi"><div class="card-title">‚òÅÔ∏è Perfil de vuelo y nubes</div>';
  h += '<div style="position:relative;background:#0d1220;border-radius:10px;padding:12px;overflow:hidden">';
  h += '<canvas id="cloudChart" width="760" height="340" style="width:100%;height:170px;display:block"></canvas>';
  h += '</div>';
  h += '<div style="margin-top:10px;display:flex;gap:16px;justify-content:center;font-size:11px;color:#7a8ba8">';
  h += '<span><span style="display:inline-block;width:10px;height:10px;border-radius:2px;background:rgba(167,139,250,.5);vertical-align:middle;margin-right:4px"></span>Nubes</span>';
  h += '<span><span style="display:inline-block;width:10px;height:2px;background:#4e9eff;vertical-align:middle;margin-right:4px"></span>Tu avi√≥n</span>';
  h += '</div>';
  h += '<div style="margin-top:8px;display:flex;align-items:center;justify-content:center;gap:4px;font-size:10px;color:#4a5873">';
  h += '<span>Cobertura:</span>';
  h += '<span style="display:inline-block;width:16px;height:10px;border-radius:2px;background:rgba(167,139,250,.15)"></span><span>20%</span>';
  h += '<span style="display:inline-block;width:16px;height:10px;border-radius:2px;background:rgba(167,139,250,.35)"></span><span>40%</span>';
  h += '<span style="display:inline-block;width:16px;height:10px;border-radius:2px;background:rgba(167,139,250,.55)"></span><span>70%</span>';
  h += '<span style="display:inline-block;width:16px;height:10px;border-radius:2px;background:rgba(167,139,250,.7)"></span><span>100%</span>';
  h += '</div>';
  h += '</div>';

  // Unified Flight timeline
  h += '<div class="card fi"><div class="card-title">üïê Timeline completo</div>';
  h += '<div style="margin-bottom:12px;font-size:12px;color:#7a8ba8">Los eventos <span style="color:#4e9eff">en azul</span> son espec√≠ficos de tu vuelo. Los eventos <span style="color:#94a3b8">en gris</span> ocurren en todos los vuelos.</div>';
  h += renderTL(b.tl, b.dur) + '</div>';

  // Conditions
  h += '<div class="card fi"><div class="card-title">üå°Ô∏è Condiciones</div>';
  h += '<div class="cond-grid">';
  h += '<div class="cond-box"><div class="cond-val" style="color:#34d399">' + b.oW.temp + '¬∞C</div><div class="cond-lbl">' + b.fAP.city + ' ahora</div></div>';
  h += '<div class="cond-box"><div class="cond-val" style="color:#4e9eff">' + b.dW.temp + '¬∞C</div><div class="cond-lbl">' + b.tAP.city + ' llegada</div></div>';
  h += '<div class="cond-box"><div class="cond-val">' + b.oW.ws + ' km/h</div><div class="cond-lbl">Viento ' + b.fl.from + '</div></div>';
  h += '<div class="cond-box"><div class="cond-val">' + b.dW.ws + ' km/h</div><div class="cond-lbl">Viento ' + b.fl.to + '</div></div>';
  h += '</div></div>';

  // Seat
  if (b.sN) {
    h += '<div class="card fi"><div class="card-title">üëÅÔ∏è Tu ventanilla ¬∑ ' + seatV + '</div><div class="narr">' + b.sN + '</div></div>';
  }

  // Sound guide
  h += '<div class="card fi"><div class="card-title">üîä Gu√≠a de sonidos ¬∑ ' + b.ac.n + '</div><div class="narr" style="font-size:14px">';
  if (b.ac.bark) h += '<span class="he">üîä "Barking dog"</span> ‚Äî Sonido r√≠tmico como un ladrido. Sistema hidr√°ulico PTU. Solo Airbus.<br><br>';
  h += '<span class="he">‚öôÔ∏è Tren de aterrizaje</span> ‚Äî Golpe seco seguido de zumbido al guardar o desplegar las ruedas.<br><br>';
  h += '<span class="he">‚öôÔ∏è Flaps y slats</span> ‚Äî Piezas del borde del ala que se mueven. Zumbido suave.<br><br>';
  h += '<span class="he">‚öôÔ∏è Spoilers</span> ‚Äî Placas que se levantan en el ala al aterrizar. Visibles desde la ventanilla.<br><br>';
  h += '<span class="he">üîä Cambios de potencia</span> ‚Äî Los motores var√≠an su intensidad durante el vuelo. Nunca se apagan.<br><br>';
  h += '<span class="he">üîî Se√±ales ac√∫sticas</span> ‚Äî Comunicaci√≥n entre pilotos y tripulaci√≥n, o indicador de cinturones.';
  h += '</div></div>';

  h += '<div class="spacer"></div>';

  // Disclaimer
  h += '<div style="padding:16px 20px;margin-bottom:20px;border-top:1px solid rgba(78,158,255,.08)">';
  h += '<div style="font-size:12px;color:#4a5873;line-height:1.7;text-align:center">';
  h += 'MyFlight utiliza datos reales de vuelo y meteorolog√≠a. Las explicaciones est√°n escritas desde la experiencia de un pasajero al que le apasiona la aviaci√≥n pero conoce bien el miedo a volar. Todo el contenido busca ser riguroso, pero no sustituye la informaci√≥n oficial de las aerol√≠neas ni constituye asesoramiento profesional.';
  h += '</div></div>';

  document.getElementById('OUT').innerHTML = h;

  // Draw cloud cross-section chart
  drawCloudChart(b);

  document.getElementById('btnBack').onclick = goBack;
}

function drawCloudChart(b) {
  var canvas = document.getElementById('cloudChart');
  if (!canvas) return;
  var ctx = canvas.getContext('2d');
  var W = canvas.width;
  var H = canvas.height;
  var dur = b.dur;
  var maxAlt = 13000; // meters
  var padL = 52; // left padding for km labels
  var padR = 52; // right padding for ft labels
  var padT = 16;
  var padB = 28;
  var cW = W - padL - padR;
  var cH = H - padT - padB;

  // Clear
  ctx.fillStyle = '#0d1220';
  ctx.fillRect(0, 0, W, H);

  // Helper: x from minute
  function xM(min) { return padL + (min / dur) * cW; }
  // Helper: y from altitude
  function yA(alt) { return padT + cH - (alt / maxAlt) * cH; }

  // Grid lines and labels
  ctx.strokeStyle = 'rgba(78,158,255,.08)';
  ctx.lineWidth = 1;
  ctx.fillStyle = '#4a5873';
  ctx.font = '18px SF Mono, Menlo, monospace';

  var altGrids = [0, 3000, 6000, 9000, 12000];
  var altFtLabels = ['0', '10k', '20k', '30k', '39k'];
  for (var ag = 0; ag < altGrids.length; ag++) {
    var gy = yA(altGrids[ag]);
    ctx.beginPath();
    ctx.moveTo(padL, gy);
    ctx.lineTo(W - padR, gy);
    ctx.stroke();
    // Left: km
    ctx.textAlign = 'right';
    var kmLabel = altGrids[ag] === 0 ? '0' : (altGrids[ag] / 1000) + 'km';
    ctx.fillText(kmLabel, padL - 6, gy + 5);
    // Right: ft
    ctx.textAlign = 'left';
    ctx.fillText(altFtLabels[ag] + 'ft', W - padR + 6, gy + 5);
  }

  // Time labels at bottom
  ctx.textAlign = 'center';
  ctx.font = '18px SF Mono, Menlo, monospace';
  var timeStep = dur <= 90 ? 10 : (dur <= 180 ? 20 : 30);
  for (var tm = 0; tm <= dur; tm += timeStep) {
    var tx = xM(tm);
    ctx.fillText(tm + "'", tx, H - 4);
  }

  // Airport labels
  ctx.fillStyle = '#7a8ba8';
  ctx.font = 'bold 20px -apple-system, sans-serif';
  ctx.textAlign = 'left';
  ctx.fillText(b.fl.from, padL + 4, H - 4);
  ctx.textAlign = 'right';
  ctx.fillText(b.fl.to, W - padR - 4, H - 4);

  // Draw cloud coverage as colored columns for each route point
  // Each route point covers a time span and has a vertical profile
  var rc = b.routeClouds;
  if (rc && rc.length > 0) {
    for (var ri = 0; ri < rc.length; ri++) {
      var rp = rc[ri];
      if (!rp.w.profile) continue;

      // Time span for this point
      var fracStart = (ri === 0) ? 0 : (rc[ri-1].frac + rp.frac) / 2;
      var fracEnd = (ri === rc.length - 1) ? 1 : (rp.frac + rc[ri+1].frac) / 2;
      var x1 = xM(fracStart * dur);
      var x2 = xM(fracEnd * dur);
      var colW = x2 - x1;

      // Draw each pressure level as a band
      var prof = rp.w.profile;
      for (var pi = 0; pi < prof.length; pi++) {
        if (prof[pi].cover < 10) continue;

        var altBot = prof[pi].altM;
        // Top of this band = bottom of next, or +1500m for top level
        var altTop = (pi < prof.length - 1) ? prof[pi + 1].altM : prof[pi].altM + 1500;
        // Smooth band boundaries
        var bandBot = (pi > 0) ? (prof[pi - 1].altM + altBot) / 2 : altBot;
        var bandTop = (pi < prof.length - 1) ? (altBot + altTop) / 2 : altTop;

        var alpha = Math.min(0.7, prof[pi].cover / 100 * 0.8);
        ctx.fillStyle = 'rgba(167,139,250,' + alpha.toFixed(2) + ')';
        ctx.fillRect(x1, yA(bandTop), colW, yA(bandBot) - yA(bandTop));
      }
    }
  }

  // Draw aircraft trajectory line
  ctx.strokeStyle = '#4e9eff';
  ctx.lineWidth = 3;
  ctx.lineJoin = 'round';
  ctx.lineCap = 'round';
  ctx.beginPath();
  var steps = 100;
  for (var si = 0; si <= steps; si++) {
    var min = (si / steps) * dur;
    var alt = b.altAtMin(min);
    var px = xM(min);
    var py = yA(alt);
    if (si === 0) ctx.moveTo(px, py);
    else ctx.lineTo(px, py);
  }
  ctx.stroke();

  // Glow effect on aircraft line
  ctx.strokeStyle = 'rgba(78,158,255,.25)';
  ctx.lineWidth = 8;
  ctx.beginPath();
  for (var si2 = 0; si2 <= steps; si2++) {
    var min2 = (si2 / steps) * dur;
    var alt2 = b.altAtMin(min2);
    var px2 = xM(min2);
    var py2 = yA(alt2);
    if (si2 === 0) ctx.moveTo(px2, py2);
    else ctx.lineTo(px2, py2);
  }
  ctx.stroke();

  // Small plane icon at cruise midpoint
  ctx.fillStyle = '#4e9eff';
  ctx.font = '24px sans-serif';
  ctx.textAlign = 'center';
  var midMin = dur / 2;
  ctx.fillText('‚úà', xM(midMin), yA(b.altAtMin(midMin)) - 10);
}

// ============================================================
// NAVIGATION
// ============================================================
function showScr(show, hide, dir) {
  document.getElementById(hide).className = 'scr ' + (hide === 'S1' ? 'search' : hide === 'S2' ? 'loading' : 'brief') + (dir === 'f' ? ' off-l' : ' off-r');
  var s = document.getElementById(show);
  s.className = 'scr ' + (show === 'S1' ? 'search' : show === 'S2' ? 'loading' : 'brief');
}

function goBack() {
  var steps = ['st1','st2','st3','st4','st5'];
  for (var i = 0; i < steps.length; i++) {
    document.getElementById(steps[i]).className = 'step';
  }
  showScr('S1', 'S3', 'b');
  document.getElementById('S2').className = 'scr loading off-r';
}

function delay(ms) {
  return new Promise(function(resolve) { setTimeout(resolve, ms); });
}

async function analyze() {
  var code = document.getElementById('inFlight').value.trim().toUpperCase();
  var seat = document.getElementById('inSeat').value.trim().toUpperCase();
  var acSel = document.getElementById('inAC').value;

  if (!code) {
    document.getElementById('inFlight').style.borderColor = '#f87171';
    setTimeout(function(){ document.getElementById('inFlight').style.borderColor = ''; }, 1200);
    return;
  }

  var fl = FLIGHTS[code];
  if (!fl) {
    try {
      var apiUrl = '/api/flight?number=' + encodeURIComponent(code);
      var apiR = await fetch(apiUrl);
      if (apiR.ok) {
        var apiData = await apiR.json();
        if (!apiData.error && apiData.departure && apiData.arrival) {
          var cruiseFl = 360;
          var dur = apiData.durationMin || 120;
          if (dur < 60) cruiseFl = 280;
          else if (dur < 90) cruiseFl = 320;
          else if (dur < 150) cruiseFl = 360;
          else cruiseFl = 380;
          fl = { al: apiData.flight.airline || code.substring(0,2), from: apiData.departure.iata, to: apiData.arrival.iata, dur: dur, ac: apiData.aircraft.type || 'A320', fl: cruiseFl, depTime: apiData.departure.scheduledLocal, arrTime: apiData.arrival.scheduledLocal, depTz: apiData.departure.timezone, arrTz: apiData.arrival.timezone };
          if (!AP[fl.from] && apiData.departure.lat) {
            AP[fl.from] = { name: apiData.departure.name, city: apiData.departure.name, lat: apiData.departure.lat, lon: apiData.departure.lon, taxi: 10, dep: function(wd,ws){ if(ws<5)return{id:'01',h:10}; if(wd>=315||wd<45)return{id:'36',h:360}; if(wd>=45&&wd<135)return{id:'09',h:90}; if(wd>=135&&wd<225)return{id:'18',h:180}; return{id:'27',h:270}; }, arr: function(wd,ws){ if(ws<5)return{id:'01',h:10}; if(wd>=315||wd<45)return{id:'36',h:360}; if(wd>=45&&wd<135)return{id:'09',h:90}; if(wd>=135&&wd<225)return{id:'18',h:180}; return{id:'27',h:270}; } };
          }
          if (!AP[fl.to] && apiData.arrival.lat) {
            AP[fl.to] = { name: apiData.arrival.name, city: apiData.arrival.name, lat: apiData.arrival.lat, lon: apiData.arrival.lon, taxi: 10, dep: function(wd,ws){ if(ws<5)return{id:'01',h:10}; if(wd>=315||wd<45)return{id:'36',h:360}; if(wd>=45&&wd<135)return{id:'09',h:90}; if(wd>=135&&wd<225)return{id:'18',h:180}; return{id:'27',h:270}; }, arr: function(wd,ws){ if(ws<5)return{id:'01',h:10}; if(wd>=315||wd<45)return{id:'36',h:360}; if(wd>=45&&wd<135)return{id:'09',h:90}; if(wd>=135&&wd<225)return{id:'18',h:180}; return{id:'27',h:270}; } };
          }
        }
      }
    } catch(e) { console.log('API error:', e); }
  }
  if (!fl) {
    var inp = document.getElementById('inFlight');
    inp.style.borderColor = '#f87171';
    inp.value = '';
    inp.placeholder = 'Vuelo no encontrado';
    setTimeout(function(){ inp.style.borderColor = ''; inp.placeholder = 'Ej: IB651'; }, 3000);
    return;
  }

  var acCode = (acSel !== 'auto') ? acSel : fl.ac;
  var fAP = AP[fl.from];
  var tAP = AP[fl.to];

  showScr('S2', 'S1', 'f');

  var steps = ['st1','st2','st3','st4','st5'];
  // Step 1: flight found
  document.getElementById(steps[0]).className = 'step on';
  await delay(400);
  document.getElementById(steps[0]).className = 'step ok';

  // Step 2 & 3: fetch real weather (in parallel with animation)
  document.getElementById(steps[1]).className = 'step on';
  var weatherData = null;
  try {
    weatherData = await fetchRouteWeather(fAP, tAP, fl.depTime, fl.dur);
  } catch(e) { console.log('Weather fetch failed, using simulated', e); }
  document.getElementById(steps[1]).className = 'step ok';

  document.getElementById(steps[2]).className = 'step on';
  await delay(400);
  document.getElementById(steps[2]).className = 'step ok';

  // Step 4: predict runway
  document.getElementById(steps[3]).className = 'step on';
  await delay(400);
  document.getElementById(steps[3]).className = 'step ok';

  // Step 5: build briefing
  document.getElementById(steps[4]).className = 'step on';
  await delay(300);
  document.getElementById(steps[4]).className = 'step ok';
  await delay(200);

  var briefing = makeBriefing(fl, fAP, tAP, seat, acCode, weatherData);
  renderBriefing(briefing);
  showScr('S3', 'S2', 'f');
}

// ============================================================
// INIT
// ============================================================
document.getElementById('inDate').value = new Date().toISOString().split('T')[0];

document.getElementById('inFlight').addEventListener('input', function() {
  this.value = this.value.toUpperCase().replace(/[^A-Z0-9]/g, '');
});
document.getElementById('inSeat').addEventListener('input', function() {
  this.value = this.value.toUpperCase().replace(/[^A-Z0-9]/g, '');
});

document.getElementById('btnGo').addEventListener('click', function() { analyze(); });

var chips = document.querySelectorAll('.chip');
for (var c = 0; c < chips.length; c++) {
  chips[c].addEventListener('click', function() {
    document.getElementById('inFlight').value = this.getAttribute('data-f');
    document.getElementById('inSeat').value = this.getAttribute('data-s') || '';
  });
}
</script>
</body>
</html>
