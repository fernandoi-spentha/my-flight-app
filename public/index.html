<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<title>MyFlight</title>
<style>
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
html,body{height:100%;overflow:hidden}
body{
  font-family:-apple-system,system-ui,'Helvetica Neue',sans-serif;
  background:#0a0e1a;color:#e8edf5;-webkit-font-smoothing:antialiased;
}
.app{height:100%;width:100%;max-width:430px;margin:0 auto;position:relative;overflow:hidden}

/* Screens */
.scr{position:absolute;inset:0;overflow-y:auto;overflow-x:hidden;padding:20px;padding-top:calc(env(safe-area-inset-top,0px) + 20px);padding-bottom:calc(env(safe-area-inset-bottom,0px) + 20px);-webkit-overflow-scrolling:touch;transition:transform .4s ease,opacity .4s ease}
.scr::-webkit-scrollbar{width:0}
.scr.off-r{transform:translateX(100%);opacity:0;pointer-events:none}
.scr.off-l{transform:translateX(-30%);opacity:0;pointer-events:none}

/* Search screen */
.search{display:flex;flex-direction:column;padding-top:calc(env(safe-area-inset-top,0px) + 60px)}
.logo{text-align:center;margin-bottom:48px}
.logo-box{width:72px;height:72px;margin:0 auto 20px;background:linear-gradient(135deg,#4e9eff,#7c3aed);border-radius:22px;display:flex;align-items:center;justify-content:center;box-shadow:0 8px 32px rgba(78,158,255,.25)}
.logo-box svg{width:38px;height:38px;fill:#fff}
.logo h1{font-size:32px;font-weight:700;letter-spacing:-.5px;margin-bottom:8px}
.logo p{font-size:15px;color:#7a8ba8;line-height:1.5;max-width:280px;margin:0 auto}

.field-group{margin-bottom:16px}
.field-label{display:block;font-size:12px;font-weight:600;color:#7a8ba8;text-transform:uppercase;letter-spacing:1px;margin-bottom:8px}
.field{width:100%;padding:16px 18px;background:#0d1220;border:1.5px solid rgba(78,158,255,.1);border-radius:10px;color:#e8edf5;font-family:'SF Mono',Menlo,monospace;font-size:18px;letter-spacing:2px;outline:none;transition:border-color .2s,box-shadow .2s}
.field::placeholder{color:#4a5873;letter-spacing:1px;font-size:15px}
.field:focus{border-color:#4e9eff;box-shadow:0 0 0 4px rgba(78,158,255,.15)}
.field-row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
.field-date{font-family:-apple-system,sans-serif;font-size:15px;letter-spacing:0}
.field-seat{letter-spacing:1px}

.select{width:100%;padding:16px 18px;background:#0d1220;border:1.5px solid rgba(78,158,255,.1);border-radius:10px;color:#e8edf5;font-family:-apple-system,sans-serif;font-size:15px;outline:none;-webkit-appearance:none;appearance:none;background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' fill='%237a8ba8' viewBox='0 0 24 24'%3E%3Cpath d='M7 10l5 5 5-5z'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right 16px center}
.select:focus{border-color:#4e9eff;box-shadow:0 0 0 4px rgba(78,158,255,.15)}

.btn{width:100%;padding:18px;background:linear-gradient(135deg,#4e9eff,#3b82f6);color:#fff;border:none;border-radius:10px;font-family:-apple-system,sans-serif;font-size:16px;font-weight:600;cursor:pointer;transition:transform .15s}
.btn:active{transform:scale(.97)}

.examples{margin-top:auto}
.examples-title{font-size:12px;font-weight:600;color:#4a5873;text-transform:uppercase;letter-spacing:1px;margin-bottom:12px}
.chips{display:flex;flex-wrap:wrap;gap:8px}
.chip{padding:10px 16px;background:#131829;border:1px solid rgba(78,158,255,.1);border-radius:100px;color:#7a8ba8;font-family:'SF Mono',Menlo,monospace;font-size:13px;cursor:pointer}
.chip:active{background:#1a2035;color:#4e9eff}

/* Loading */
.loading{display:flex;flex-direction:column;align-items:center;justify-content:center;text-align:center;gap:32px}
.spinner{width:64px;height:64px;border:3px solid rgba(78,158,255,.1);border-top-color:#4e9eff;border-radius:50%;animation:spin 1s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
.steps{display:flex;flex-direction:column;gap:14px;width:100%;max-width:280px}
.step{display:flex;align-items:center;gap:12px;font-size:14px;color:#4a5873;transition:color .4s}
.step.on{color:#e8edf5}
.step.ok{color:#34d399}
.step-dot{width:8px;height:8px;border-radius:50%;background:#4a5873;flex-shrink:0;transition:all .4s}
.step.on .step-dot{background:#4e9eff;box-shadow:0 0 8px #4e9eff}
.step.ok .step-dot{background:#34d399}

/* Briefing */
.brief{padding-top:calc(env(safe-area-inset-top,0px) + 16px)}
.header{display:flex;align-items:center;gap:12px;margin-bottom:20px}
.back{width:40px;height:40px;border-radius:12px;background:#131829;border:1px solid rgba(78,158,255,.1);color:#7a8ba8;display:flex;align-items:center;justify-content:center;cursor:pointer;flex-shrink:0}
.back:active{background:#1a2035;color:#4e9eff}
.route{flex:1}
.route-codes{font-size:22px;font-weight:700}
.route-arrow{color:#4a5873;margin:0 6px;font-weight:400}
.route-sub{font-size:13px;color:#7a8ba8;margin-top:3px}
.badge{padding:6px 14px;background:rgba(78,158,255,.08);border:1px solid rgba(78,158,255,.2);border-radius:100px;font-family:'SF Mono',Menlo,monospace;font-size:13px;color:#4e9eff;font-weight:500}

.live{display:inline-flex;align-items:center;gap:6px;padding:4px 10px;background:rgba(52,211,153,.1);border:1px solid rgba(52,211,153,.2);border-radius:100px;font-size:11px;color:#34d399;font-weight:500;margin-bottom:16px}
.live-dot{width:6px;height:6px;background:#34d399;border-radius:50%;animation:pulse 2s infinite}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.4}}

/* Tabs */
.tabs{display:flex;gap:4px;background:#0d1220;border-radius:12px;padding:4px;margin-bottom:20px}
.tab{flex:1;padding:12px 8px;border:none;border-radius:10px;font-family:-apple-system,sans-serif;font-size:14px;font-weight:600;cursor:pointer;background:transparent;color:#4a5873;transition:all .25s}
.tab.on{background:#131829;color:#e8edf5;box-shadow:0 2px 8px rgba(0,0,0,.3)}
.pane{display:none}
.pane.on{display:block}

/* Cards */
.card{background:#131829;border:1px solid rgba(78,158,255,.1);border-radius:16px;padding:20px;margin-bottom:16px}
.card-title{display:flex;align-items:center;gap:10px;font-size:13px;font-weight:600;color:#7a8ba8;text-transform:uppercase;letter-spacing:.8px;margin-bottom:14px}
.narr{font-size:16px;line-height:1.75}

.hc{color:#a78bfa;font-weight:500}
.hg{color:#34d399;font-weight:500}
.hw{color:#fbbf24;font-weight:500}
.hi{color:#4e9eff;font-weight:500}
.he{color:#fb923c;font-weight:500}

/* Safety */
.safety{background:rgba(52,211,153,.06);border:1px solid rgba(52,211,153,.15);border-radius:16px;padding:16px 20px;margin-bottom:16px;display:flex;align-items:flex-start;gap:12px}
.safety-text{font-size:14px;color:#34d399;line-height:1.6}

/* Duration box */
.dur-box{background:#0d1220;border-radius:12px;padding:16px 20px;margin-bottom:16px;display:flex;align-items:center;justify-content:space-between}
.dur-label{font-size:13px;color:#7a8ba8;text-transform:uppercase;letter-spacing:.5px}
.dur-val{font-size:22px;font-weight:700;color:#4e9eff}

/* Timeline */
.tl-item{display:flex;gap:14px;padding-bottom:20px;position:relative}
.tl-item:last-child{padding-bottom:0}
.tl-left{display:flex;flex-direction:column;align-items:center;width:44px;flex-shrink:0}
.tl-time{font-family:'SF Mono',Menlo,monospace;font-size:11px;color:#4a5873;margin-bottom:8px;white-space:nowrap}
.tl-dot{width:10px;height:10px;border-radius:50%;flex-shrink:0;z-index:1}
.tl-dot-acc{background:#4e9eff}
.tl-dot-cld{background:#a78bfa}
.tl-dot-ok{background:#34d399}
.tl-dot-wrn{background:#fbbf24}
.tl-dot-ev{background:#fb923c}
.tl-dot-gen{background:#64748b}
.tl-line{width:2px;flex:1;background:rgba(78,158,255,.1);margin-top:6px}
.tl-right{flex:1}
.tl-title{font-size:14px;font-weight:600;margin-bottom:4px}
.tl-desc{font-size:13px;color:#7a8ba8;line-height:1.5}
.tl-safe{font-size:12px;color:#34d399;margin-top:4px;font-style:italic}
.tl-gen{font-size:12px;color:#94a3b8;margin-top:4px;padding:8px 12px;background:rgba(100,116,139,.06);border-radius:8px;border-left:2px solid #334155;line-height:1.5}
.tl-item-gen{margin-left:20px}
.tl-item-gen .tl-title{font-size:13px;font-weight:500}
.tl-item-gen .tl-dot{width:8px;height:8px}
.tl-phase{padding:6px 14px;background:rgba(78,158,255,.06);border:1px solid rgba(78,158,255,.12);border-radius:10px;font-size:12px;font-weight:600;color:#4e9eff;text-transform:uppercase;letter-spacing:.8px;margin-bottom:16px;text-align:center}

/* Cloud bars */
.cv-row{display:flex;align-items:center;gap:12px;padding:8px 0;border-bottom:1px solid rgba(78,158,255,.1)}
.cv-row:last-child{border-bottom:none}
.cv-alt{font-family:'SF Mono',Menlo,monospace;font-size:11px;color:#4a5873;width:58px;text-align:right}
.cv-wrap{flex:1;height:8px;background:rgba(255,255,255,.05);border-radius:4px;overflow:hidden}
.cv-bar{height:100%;border-radius:4px}
.cv-bar-cld{background:#a78bfa}
.cv-bar-ok{background:#34d399}
.cv-pct{font-size:12px;color:#7a8ba8;width:40px}

/* Conditions */
.cond-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
.cond-box{background:#0a0e1a;border-radius:10px;padding:14px;text-align:center}
.cond-val{font-size:22px;font-weight:700;margin-bottom:4px}
.cond-lbl{font-size:11px;color:#7a8ba8;text-transform:uppercase;letter-spacing:.5px}
.turb-bar{height:8px;border-radius:4px;background:#0a0e1a;overflow:hidden;margin-top:12px;margin-bottom:6px}
.turb-fill{height:100%;border-radius:4px;width:20%;background:#34d399}
.turb-label{font-size:12px;color:#7a8ba8;display:flex;justify-content:space-between}

/* Animations */
.fi{animation:fadeUp .5s ease both}
@keyframes fadeUp{from{opacity:0;transform:translateY(16px)}to{opacity:1;transform:translateY(0)}}

.spacer{height:40px}
</style>
</head>
<body>
<div class="app">

<!-- ====== SEARCH ====== -->
<div id="S1" class="scr search">
  <div class="logo">
    <div class="logo-box"><svg viewBox="0 0 24 24"><path d="M21 16v-2l-8-5V3.5A1.5 1.5 0 0 0 11.5 2 1.5 1.5 0 0 0 10 3.5V9l-8 5v2l8-2.5V19l-2 1.5V22l3.5-1 3.5 1v-1.5L13 19v-5.5l8 2.5z"/></svg></div>
    <h1>MyFlight</h1>
    <p>Tu copiloto narrativo. Sabe lo que vas a sentir antes de despegar.</p>
  </div>
  <div>
    <div class="field-group"><label class="field-label">N√∫mero de vuelo</label><input id="inFlight" class="field" type="text" placeholder="Ej: IB3170" maxlength="10" autocapitalize="characters" autocomplete="off" spellcheck="false"></div>
    <div class="field-row">
      <div class="field-group"><label class="field-label">Fecha</label><input id="inDate" class="field field-date" type="date"></div>
      <div class="field-group"><label class="field-label">Tu asiento</label><input id="inSeat" class="field field-seat" type="text" placeholder="Ej: 14A" maxlength="4" autocapitalize="characters"></div>
    </div>
    <div class="field-group"><label class="field-label">Tipo de avi√≥n</label>
      <select id="inAC" class="select">
        <option value="auto">Autom√°tico</option>
        <option value="A320">Airbus A320</option><option value="A321">Airbus A321</option>
        <option value="A320neo">Airbus A320neo</option><option value="B738">Boeing 737-800</option>
        <option value="B38M">Boeing 737 MAX</option><option value="E190">Embraer E190</option>
      </select>
    </div>
    <div style="height:16px"></div>
    <button class="btn" id="btnGo">Analizar mi vuelo</button>
  </div>
  <div class="examples" style="margin-top:32px">
    <div class="examples-title">Prueba con un ejemplo</div>
    <div class="chips">
      <span class="chip" data-f="IB3170" data-s="14A">IB3170 MAD‚ÜíFCO</span>
      <span class="chip" data-f="VY1001" data-s="12F">VY1001 BCN‚ÜíMAD</span>
      <span class="chip" data-f="BA456" data-s="22A">BA456 LHR‚ÜíMAD</span>
    </div>
  </div>
</div>

<!-- ====== LOADING ====== -->
<div id="S2" class="scr loading off-r">
  <div class="spinner"></div>
  <div style="font-size:18px;font-weight:600">Analizando tu vuelo</div>
  <div class="steps">
    <div class="step" id="st1"><span class="step-dot"></span>Buscando ruta y horarios</div>
    <div class="step" id="st2"><span class="step-dot"></span>Consultando capas de nubes</div>
    <div class="step" id="st3"><span class="step-dot"></span>Analizando viento y condiciones</div>
    <div class="step" id="st4"><span class="step-dot"></span>Prediciendo pista y aproximaci√≥n</div>
    <div class="step" id="st5"><span class="step-dot"></span>Preparando tu briefing</div>
  </div>
</div>

<!-- ====== BRIEFING ====== -->
<div id="S3" class="scr brief off-r">
  <div id="OUT"></div>
  <div class="spacer"></div>
</div>

</div>
<script>
// ============================================================
// DATA
// ============================================================
var AP = {
  MAD:{name:"Madrid Barajas",city:"Madrid",lat:40.4722,lon:-3.5608,taxi:12,
    dep:function(wd,ws){return(wd>90&&wd<270&&ws>8)?{id:"14L",h:144}:{id:"36L",h:3};},
    arr:function(wd,ws){return(wd>90&&wd<270&&ws>8)?{id:"18R",h:183}:{id:"32L",h:324};}},
  BCN:{name:"Barcelona El Prat",city:"Barcelona",lat:41.2974,lon:2.0833,taxi:8,
    dep:function(wd,ws){return((wd>180&&wd<360)||wd<10)?{id:"07R",h:74}:{id:"25L",h:254};},
    arr:function(wd,ws){return((wd>180&&wd<360)||wd<10)?{id:"07L",h:70}:{id:"25R",h:250};}},
  FCO:{name:"Roma Fiumicino",city:"Roma",lat:41.8003,lon:12.2389,taxi:10,
    dep:function(wd,ws){return(wd>270||wd<90)?{id:"34L",h:343}:{id:"16R",h:163};},
    arr:function(wd,ws){return(wd>270||wd<90)?{id:"34R",h:343}:{id:"16L",h:163};}},
  LHR:{name:"London Heathrow",city:"Londres",lat:51.47,lon:-0.4543,taxi:15,
    dep:function(wd,ws){return(wd>180&&wd<360)?{id:"09R",h:92}:{id:"27L",h:272};},
    arr:function(wd,ws){return(wd>180&&wd<360)?{id:"09L",h:92}:{id:"27R",h:272};}},
  STN:{name:"London Stansted",city:"Londres",lat:51.885,lon:0.235,taxi:7,
    dep:function(wd,ws){return(wd>100&&wd<280)?{id:"22",h:220}:{id:"04",h:40};},
    arr:function(wd,ws){return(wd>100&&wd<280)?{id:"22",h:220}:{id:"04",h:40};}},
  LIS:{name:"Lisboa Portela",city:"Lisboa",lat:38.7756,lon:-9.1354,taxi:8,
    dep:function(wd,ws){return(wd>120&&wd<300)?{id:"21",h:210}:{id:"03",h:30};},
    arr:function(wd,ws){return(wd>120&&wd<300)?{id:"21",h:210}:{id:"03",h:30};}},
};

var AC = {
  A320:{n:"Airbus A320",bark:true},A321:{n:"Airbus A321",bark:true},
  A320neo:{n:"Airbus A320neo",bark:true},A319:{n:"Airbus A319",bark:true},
  A330:{n:"Airbus A330",bark:true},A350:{n:"Airbus A350",bark:false},
  B738:{n:"Boeing 737-800",bark:false},B38M:{n:"Boeing 737 MAX",bark:false},
  B787:{n:"Boeing 787 Dreamliner",bark:false},B777:{n:"Boeing 777",bark:false},
  E190:{n:"Embraer E190",bark:false},E195:{n:"Embraer E195",bark:false},
  ATR:{n:"ATR 72",bark:false},CRJ:{n:"CRJ",bark:false},
};

var FLIGHTS = {
  IB3170:{al:"Iberia",from:"MAD",to:"FCO",dur:155,ac:"A321",fl:360},
  VY1001:{al:"Vueling",from:"BCN",to:"MAD",dur:75,ac:"A320",fl:340},
  BA456:{al:"British Airways",from:"LHR",to:"MAD",dur:145,ac:"A320",fl:370},
  FR5994:{al:"Ryanair",from:"STN",to:"MAD",dur:150,ac:"B738",fl:360},
  IB3100:{al:"Iberia",from:"MAD",to:"LHR",dur:155,ac:"A321",fl:380},
  TP1024:{al:"TAP",from:"LIS",to:"MAD",dur:75,ac:"A320neo",fl:320},
};

// ============================================================
// WEATHER ‚Äî Open-Meteo (real data)
// ============================================================
function simWeather(lat) {
  // Fallback if API fails
  var mo = new Date().getMonth();
  var winter = (mo >= 10 || mo <= 2);
  var med = (lat < 45 && lat > 35);
  var base = med ? (winter ? 12 : 28) : (winter ? 6 : 21);
  var temp = base + Math.round((Math.random() - 0.5) * 6);
  var ws = 5 + Math.round(Math.random() * 18);
  var wd = Math.round(Math.random() * 360);
  var cb = med ? (winter ? 40 : 15) : (winter ? 55 : 30);
  var cL = Math.min(100, Math.max(0, Math.round(cb + (Math.random() - 0.5) * 40)));
  var cM = Math.min(100, Math.max(0, Math.round(cb * 0.7 + (Math.random() - 0.5) * 30)));
  var cH = Math.min(100, Math.max(0, Math.round(cb * 0.4 + (Math.random() - 0.5) * 25)));
  return {temp:temp, ws:ws, wd:wd, cL:cL, cM:cM, cH:cH, real:false};
}

async function fetchWeather(lat, lon) {
  try {
    // Get current hour for indexing hourly data
    var now = new Date();
    var hour = now.getUTCHours();

    var url = 'https://api.open-meteo.com/v1/forecast?latitude=' + lat + '&longitude=' + lon
      + '&current=temperature_2m,wind_speed_10m,wind_direction_10m,cloud_cover'
      + '&hourly=cloud_cover_1000hPa,cloud_cover_925hPa,cloud_cover_850hPa,cloud_cover_700hPa,cloud_cover_600hPa,cloud_cover_500hPa,cloud_cover_400hPa,cloud_cover_300hPa,cloud_cover_250hPa,cloud_cover_200hPa'
      + '&forecast_days=1&timezone=UTC';
    var r = await fetch(url);
    if (!r.ok) throw new Error('HTTP ' + r.status);
    var d = await r.json();
    var c = d.current;
    var h = d.hourly;

    // Build vertical cloud profile from pressure levels
    // Each level: {hPa, altM (approx meters), altFt (approx feet), cover %}
    var profile = [
      {hPa:1000, altM:100,   altFt:300,    cover: h.cloud_cover_1000hPa[hour]},
      {hPa:925,  altM:750,   altFt:2500,   cover: h.cloud_cover_925hPa[hour]},
      {hPa:850,  altM:1500,  altFt:5000,   cover: h.cloud_cover_850hPa[hour]},
      {hPa:700,  altM:3000,  altFt:10000,  cover: h.cloud_cover_700hPa[hour]},
      {hPa:600,  altM:4200,  altFt:14000,  cover: h.cloud_cover_600hPa[hour]},
      {hPa:500,  altM:5500,  altFt:18000,  cover: h.cloud_cover_500hPa[hour]},
      {hPa:400,  altM:7200,  altFt:24000,  cover: h.cloud_cover_400hPa[hour]},
      {hPa:300,  altM:9200,  altFt:30000,  cover: h.cloud_cover_300hPa[hour]},
      {hPa:250,  altM:10400, altFt:34000,  cover: h.cloud_cover_250hPa[hour]},
      {hPa:200,  altM:11800, altFt:39000,  cover: h.cloud_cover_200hPa[hour]}
    ];

    // Derive low/mid/high for legacy compatibility
    var cL = Math.max(profile[0].cover, profile[1].cover, profile[2].cover);
    var cM = Math.max(profile[3].cover, profile[4].cover, profile[5].cover);
    var cH = Math.max(profile[6].cover, profile[7].cover, profile[8].cover, profile[9].cover);

    return {
      temp: Math.round(c.temperature_2m),
      ws: Math.round(c.wind_speed_10m),
      wd: Math.round(c.wind_direction_10m),
      cL: Math.round(cL),
      cM: Math.round(cM),
      cH: Math.round(cH),
      profile: profile,
      real: true
    };
  } catch(e) {
    console.log('Weather API error for', lat, lon, e);
    return simWeather(lat);
  }
}

async function fetchRouteWeather(fAP, tAP) {
  // Fetch weather for 8 points along the route: origin, 6 intermediate, destination
  var points = [];
  for (var i = 0; i <= 7; i++) {
    var frac = i / 7;
    var lat = fAP.lat + (tAP.lat - fAP.lat) * frac;
    var lon = fAP.lon + (tAP.lon - fAP.lon) * frac;
    points.push({frac: frac, lat: lat, lon: lon});
  }
  // Fetch all in parallel
  var promises = points.map(function(p) { return fetchWeather(p.lat, p.lon); });
  var results = await Promise.all(promises);
  var routeW = [];
  for (var j = 0; j < points.length; j++) {
    routeW.push({frac: points[j].frac, w: results[j]});
  }
  return {
    origin: results[0],
    destination: results[results.length - 1],
    route: routeW
  };
}

// ============================================================
// UTILS
// ============================================================
function card(h){var d=['norte','noreste','este','sureste','sur','suroeste','oeste','noroeste'];return d[Math.round(h/45)%8];}
function brg(a,b,c,d){var R=Math.PI/180;var e=R*(d-b);var f=Math.sin(e)*Math.cos(R*c);var g=Math.cos(R*a)*Math.sin(R*c)-Math.sin(R*a)*Math.cos(R*c)*Math.cos(e);return((Math.atan2(f,g)*180/Math.PI)+360)%360;}
function ftToM(f){return f*0.3048;}

// FIX #1: Turn direction (izquierda/derecha)
function turnDir(depHdg, routeHdg) {
  var diff = ((routeHdg - depHdg) + 360) % 360;
  return (diff <= 180) ? 'derecha' : 'izquierda';
}

// FIX #4: Realistic climb time based on cruise FL
function climbMinutes(fl) {
  if (fl <= 300) return 18;
  if (fl <= 340) return 20;
  if (fl <= 380) return 23;
  return 25;
}

function climbAlt(min, crM, climbMin) {
  if (min >= climbMin) return crM;
  var p = min / climbMin;
  return crM * (1 - Math.pow(1 - p, 2));
}

// ============================================================
// BRIEFING BUILDER
// ============================================================
function makeBriefing(fl, fAP, tAP, seat, acCode, weatherData) {
  var ac = AC[acCode] || AC[fl.ac] || AC['A320'];
  var cruiseFL = fl.fl || 360;
  var crM = ftToM(cruiseFL * 100);
  var dur = fl.dur;
  var climbMin = climbMinutes(cruiseFL);

  // Use real weather data or fallback to simulated
  var oW = weatherData ? weatherData.origin : simWeather(fAP.lat);
  var dW = weatherData ? weatherData.destination : simWeather(tAP.lat);
  var isRealWeather = weatherData && oW.real;

  // Route clouds from real data or simulated
  var routeClouds = [];
  if (weatherData && weatherData.route) {
    routeClouds = weatherData.route;
  } else {
    for (var i = 0; i <= 6; i++) {
      var frac = i / 6;
      var lat = fAP.lat + (tAP.lat - fAP.lat) * frac;
      routeClouds.push({frac: frac, w: simWeather(lat)});
    }
  }

  var depR = fAP.dep(oW.wd, oW.ws);
  var arrR = tAP.arr(dW.wd, dW.ws);
  var rHdg = brg(fAP.lat, fAP.lon, tAP.lat, tAP.lon);

  // FIX #1: Get turn direction
  var tDir = turnDir(depR.h, rHdg);

  // ---- CLOUD LAYERS from vertical profile ----
  // We use origin profile for climb and destination profile for descent
  // For each, detect contiguous cloud layers (cover > 30%)
  function detectCloudLayers(profile) {
    if (!profile) return [];
    var layers = [];
    var inCloud = false;
    var base = 0, top = 0, maxCov = 0;
    for (var i = 0; i < profile.length; i++) {
      var p = profile[i];
      if (p.cover > 30) {
        if (!inCloud) {
          inCloud = true;
          base = p.altM;
          maxCov = p.cover;
        }
        top = p.altM;
        if (p.cover > maxCov) maxCov = p.cover;
      } else {
        if (inCloud) {
          layers.push({baseM: base, topM: top, baseFt: Math.round(base*3.281), topFt: Math.round(top*3.281), maxCover: maxCov, thick: (maxCov > 60)});
          inCloud = false;
        }
      }
    }
    if (inCloud) {
      layers.push({baseM: base, topM: top, baseFt: Math.round(base*3.281), topFt: Math.round(top*3.281), maxCover: maxCov, thick: (maxCov > 60)});
    }
    return layers;
  }

  var originLayers = detectCloudLayers(oW.profile);
  var destLayers = detectCloudLayers(dW.profile);

  // Convert cloud layers to timeline events during climb (origin) and descent (dest)
  // Climb: altitude as function of time
  function altAtMin(min) {
    if (min <= 0) return 0;
    if (min < climbMin) return climbAlt(min, crM, climbMin);
    if (min > dur - 18) {
      var descMin = dur - min;
      return climbAlt(descMin, crM, climbMin);
    }
    return crM;
  }
  function minAtAlt(altM, phase) {
    // phase: 'climb' or 'descent'
    if (phase === 'climb') {
      // Inverse of climbAlt: altM = crM * (1 - (1 - min/climbMin)^2)
      // => min = climbMin * (1 - sqrt(1 - altM/crM))
      var ratio = altM / crM;
      if (ratio >= 1) return climbMin;
      return Math.round(climbMin * (1 - Math.sqrt(1 - ratio)));
    } else {
      // Descent: mirror of climb, starts at dur-18
      var ratio2 = altM / crM;
      if (ratio2 >= 1) return dur - 18;
      var descTime = climbMin * (1 - Math.sqrt(1 - ratio2));
      return Math.round(dur - descTime);
    }
  }

  var cEvents = [];
  // Climb cloud events from origin
  for (var ol = 0; ol < originLayers.length; ol++) {
    var lay = originLayers[ol];
    if (lay.topM < crM) { // Only layers below cruise
      var enterMin = minAtAlt(lay.baseM, 'climb');
      var exitMin = minAtAlt(lay.topM, 'climb');
      if (enterMin < climbMin && exitMin > 0) {
        var desc = lay.thick ? 'Capa densa' : 'Capa parcial';
        cEvents.push({t:'in', min:enterMin, alt:lay.baseM, topAlt:lay.topM, cover:lay.maxCover, thick:lay.thick,
          desc: desc + ' (' + lay.maxCover + '%) entre ' + lay.baseM.toLocaleString() + 'm y ' + lay.topM.toLocaleString() + 'm.'});
        cEvents.push({t:'out', min:exitMin, alt:lay.topM});
      }
    }
  }

  // Route cloud events (mid-cruise) from sampled route points
  // Check if any route point has significant cloud at cruise altitude
  var routeTurb = false;
  for (var rp = 0; rp < routeClouds.length; rp++) {
    var rc = routeClouds[rp];
    if (rc.w.profile) {
      for (var pl = 0; pl < rc.w.profile.length; pl++) {
        var pLevel = rc.w.profile[pl];
        if (pLevel.altM >= crM - 1500 && pLevel.altM <= crM + 1500 && pLevel.cover > 40) {
          routeTurb = true;
          break;
        }
      }
    }
    if (routeTurb) break;
  }

  // Destination cloud layers for descent
  var dcEvents = [];
  for (var dl = 0; dl < destLayers.length; dl++) {
    var dlay = destLayers[dl];
    if (dlay.topM < crM) {
      var dEnterMin = minAtAlt(dlay.topM, 'descent');
      var dExitMin = minAtAlt(dlay.baseM, 'descent');
      if (dEnterMin < dur && dExitMin > dur - 18) {
        dcEvents.push({enterMin: dur - dEnterMin, exitMin: dur - dExitMin, baseM: dlay.baseM, topM: dlay.topM, cover: dlay.maxCover, thick: dlay.thick});
      }
    }
  }

  // Turn duration: degrees / 3¬∞/s, rounded to nearest 5s
  var turnDeg = Math.abs(((depR.h - rHdg + 540) % 360) - 180);
  var turnSec = Math.round((turnDeg / 3) / 5) * 5;
  if (turnSec < 10) turnSec = 10;

  // Day or night? Simple check: 7-20h local = day
  var isDaytime = true;
  if (fl.depTime) {
    var depDt = new Date(fl.depTime.replace(/[+-]\d{2}:\d{2}$/, ''));
    var depHr = depDt.getUTCHours();
    isDaytime = (depHr >= 7 && depHr < 20);
  }

  // Helper: cloud visual description based on day/night
  function cloudVisual(thick) {
    if (isDaytime) {
      return thick ? 'Se ver√° todo blanco por la ventanilla.' : 'Entrar√°s y saldr√°s de nubes ‚Äî ver√°s alternarse blanco y cielo.';
    } else {
      return thick ? 'No ver√°s luces fuera, y probablemente una luz brillante cada pocos segundos ‚Äî son los strobes (luces intermitentes de alta intensidad en las alas) reflejando en el agua de las nubes.' : 'Notar√°s que las luces del exterior desaparecen al entrar en las nubes.';
    }
  }

  // Helper: altitude string with meters and feet
  function altStr(m) {
    return m.toLocaleString() + 'm / ' + Math.round(m * 3.281).toLocaleString() + 'ft';
  }

  // ---- UNIFIED TIMELINE ----
  // All events go in one timeline. type:'flight' for this-flight data, type:'always' for generic info
  var tl = [];

  // === PRE-DEPARTURE ===
  tl.push({min:-20, icon:'üö™', c:'acc', type:'flight', title:'Embarque y preparaci√≥n', desc:'Acom√≥date en tu asiento y familiar√≠zate con el entorno. Cintur√≥n abrochado, m√≥vil en modo avi√≥n.'});

  tl.push({min:-10, icon:'üîß', c:'ev', type:'always', title:'Encendido de motores', desc:'Se enciende primero el motor izquierdo, despu√©s el derecho. Los escuchar√°s acelerando, uno a uno.'});

  if (ac.bark) {
    tl.push({min:-9, icon:'üîä', c:'ev', type:'always', title:'"Barking dog" ‚Äî sonido hidr√°ulico', desc:'Un sonido r√≠tmico parecido a un ladrido debajo del avi√≥n. Es el sistema PTU equilibrando la presi√≥n hidr√°ulica entre los dos motores. Solo ocurre en Airbus y desaparece cuando ambos est√°n en marcha.'});
  }

  tl.push({min:-5, icon:'üöú', c:'acc', type:'always', title:'Push back y carreteo', desc:'Un tractor empuja el avi√≥n hacia atr√°s para salir de la puerta de embarque. Despu√©s, el avi√≥n rueda por su propio medio hasta la pista. El tiempo de carreteo var√≠a seg√∫n el tr√°fico y la posici√≥n (estimado: ~' + fAP.taxi + ' minutos).'});

  tl.push({min:-1, icon:'üì¢', c:'acc', type:'always', title:'"Tripulaci√≥n, preparados para despegue"', desc:'El comandante avisa a la tripulaci√≥n. Las azafatas toman asiento. El avi√≥n se alinea con la pista.'});

  // === TAKEOFF ===
  tl.push({min:0, icon:'üõ´', c:'acc', type:'flight', title:'Despegue ‚Äî pista ' + depR.id, desc:'Direcci√≥n ' + card(depR.h) + '. Desde que escuchas el avi√≥n acelerar hasta que despega son aproximadamente 40-50 segundos.'});

  tl.push({min:0.7, icon:'‚öôÔ∏è', c:'ev', type:'always', title:'Retracci√≥n del tren de aterrizaje', desc:'Unos segundos despu√©s de despegar escuchar√°s un golpe seco seguido de un zumbido debajo del avi√≥n. Son las ruedas recogi√©ndose. Dura pocos segundos.'});

  tl.push({min:1, icon:'üîä', c:'ev', type:'always', title:'Reducci√≥n de potencia', desc:'Entre 40 y 60 segundos despu√©s del despegue, notar√°s que los motores suenan menos intensos y parece que el avi√≥n deja de subir. Es completamente normal: simplemente ya no hace falta tanta potencia.'});

  // Turn
  tl.push({min:2, icon:'‚úàÔ∏è', c:'acc', type:'flight', title:'Viraje hacia ' + card(rHdg) + ' (' + tDir + ')', desc:'El avi√≥n gira hacia la ' + tDir + '. El viraje dura aproximadamente ' + turnSec + ' segundos.'});

  tl.push({min:3.5, icon:'‚öôÔ∏è', c:'ev', type:'always', title:'Retracci√≥n de flaps', desc:'Las piezas del borde del ala se recogen de forma progresiva. Puedes o√≠r un suave zumbido. Si miras la ventanilla, ver√°s el ala "limpiarse". Ya vuelas m√°s r√°pido y no son necesarios.'});

  tl.push({min:6, icon:'üîä', c:'ev', type:'always', title:'Ascenso escalonado', desc:'Sobre todo en √°reas con mucho tr√°fico a√©reo, puedes sentir c√≥mo el avi√≥n sube por "escalones": sube, se estabiliza, y vuelve a subir. Los motores var√≠an su intensidad con cada cambio. Es la forma habitual de gestionar el ascenso.'});

  // Climb cloud events
  for (var k = 0; k < cEvents.length; k++) {
    var ce = cEvents[k];
    if (ce.t === 'in') {
      var cNarr = 'Capa ' + (ce.thick ? 'densa' : 'parcial') + ' (' + ce.cover + '%, entre ' + altStr(ce.alt) + ' y ' + altStr(ce.topAlt) + '). ' + cloudVisual(ce.thick);
      tl.push({min:ce.min, icon:'‚òÅÔ∏è', c:'cld', type:'flight', title:'Entras en nubes (minuto ' + ce.min + ')', desc:cNarr});
    } else {
      tl.push({min:ce.min, icon:'‚òÄÔ∏è', c:'ok', type:'flight', title:'Sales de las nubes (minuto ' + ce.min + ')', desc:'Cielo despejado a ' + altStr(ce.alt) + '.'});
    }
  }

  // === CRUISE ===
  tl.push({min:climbMin, icon:'‚úàÔ∏è', c:'ok', type:'flight', title:'Altitud de crucero', desc:'El avi√≥n se estabiliza y los motores reducen potencia.'});

  tl.push({min:climbMin, icon:'üìã', c:'ev', type:'always', title:'Datos de crucero', desc:'Los aviones comerciales vuelan entre FL300 y FL400 (entre 9.000 y 12.000 metros). Siempre existe una separaci√≥n vertical de 1.000 pies (300 metros) y horizontal con otros aviones. La altura exacta depende de la meteorolog√≠a, el tr√°fico y el plan de vuelo. Durante el vuelo puede variar, por eso sentir√°s que el avi√≥n sube y/o baja ocasionalmente.'});

  tl.push({min:climbMin + 1, icon:'üîî', c:'ev', type:'always', title:'Se√±al de cinturones', desc:'Escuchar√°s un tono. Dependiendo de la aerol√≠nea, puede indicar que se apaga la se√±al de cinturones o ser comunicaci√≥n entre pilotos y tripulaci√≥n.'});

  // Route clouds at cruise altitude
  if (routeTurb) {
    tl.push({min:climbMin + 5, icon:'‚òÅÔ∏è', c:'cld', type:'flight', title:'Nubes a nivel de crucero', desc:'Se detectan nubes cerca de la altitud de crucero en parte de la ruta. Es posible que haya algunos momentos de turbulencia ligera.'});
    tl.push({min:climbMin + 5, icon:'üîî', c:'wrn', type:'always', title:'Sobre la turbulencia', desc:'Las turbulencias son inc√≥modas para el pasajero pero no suponen ning√∫n peligro para el avi√≥n. Los pilotos est√°n tranquilos en cabina y, si pueden, adaptar√°n la ruta para reducir las molestias. Es importante mantener el cintur√≥n de seguridad abrochado durante todo el vuelo, especialmente en zonas de turbulencia, seg√∫n las indicaciones de la tripulaci√≥n.'});
  } else {
    tl.push({min:climbMin + 5, icon:'‚úàÔ∏è', c:'ok', type:'flight', title:'Crucero tranquilo', desc:'Una vez alcanzada la altitud de crucero, no se prev√©n nubes a la altura de vuelo. Vuelo tranquilo.'});
  }

  if (dur > 90) tl.push({min:Math.round(dur*0.35), icon:'üçΩÔ∏è', c:'acc', type:'always', title:'Servicio a bordo', desc:'La tripulaci√≥n comienza el servicio de comidas y bebidas.'});

  // === DESCENT ===
  tl.push({min:dur-22, icon:'üì¢', c:'acc', type:'flight', title:'Inicio del descenso', desc:'Los motores reducen su potencia al m√≠nimo. Es la forma habitual de iniciar el descenso: el avi√≥n desciende planeando de forma controlada.'});

  tl.push({min:dur-15, icon:'üîä', c:'ev', type:'always', title:'Motores al m√≠nimo', desc:'Al descender, los motores van a potencia m√≠nima. Puede parecer que se apagan, pero siguen funcionando. Un avi√≥n puede planear decenas de kil√≥metros sin necesidad de empuje.'});

  // Descent cloud events
  for (var dc = 0; dc < dcEvents.length; dc++) {
    var dce = dcEvents[dc];
    var minsLeft = dce.enterMin;
    var minsLeftExit = dce.exitMin;
    var dCloudNarr = 'Capa ' + (dce.thick ? 'densa' : 'parcial') + ' (' + dce.cover + '%, entre ' + altStr(dce.topM) + ' y ' + altStr(dce.baseM) + '). ' + cloudVisual(dce.thick);
    tl.push({min:dur - minsLeft, icon:'‚òÅÔ∏è', c:'cld', type:'flight', title:'Nubes en descenso (faltan ~' + minsLeft + ' min)', desc:dCloudNarr});
    if (dce.baseM > 200) {
      tl.push({min:dur - minsLeftExit, icon:'üëÅÔ∏è', c:'ok', type:'flight', title:'Sales de las nubes (faltan ~' + minsLeftExit + ' min)', desc:'Desde que sales de las nubes, quedan aproximadamente ' + minsLeftExit + ' minutos para aterrizar.'});
    }
  }

  tl.push({min:dur-5, icon:'‚öôÔ∏è', c:'ev', type:'always', title:'Flaps desplegados', desc:'Empezar√°s a ver los flaps despleg√°ndose. Lo hacen de forma escalonada, normalmente en dos o tres pasos. En cuanto se despliegan, notar√°s c√≥mo el avi√≥n reduce su velocidad.'});

  tl.push({min:dur-3, icon:'üîä', c:'ev', type:'always', title:'Ajustes de potencia en aproximaci√≥n', desc:'Los motores suben y bajan durante la aproximaci√≥n final. El piloto ajusta la velocidad para seguir la senda de descenso con precisi√≥n.'});

  tl.push({min:dur-2, icon:'‚öôÔ∏è', c:'ev', type:'always', title:'Tren de aterrizaje desplegado', desc:'Escuchar√°s un ruido bajo el avi√≥n: son las ruedas saliendo para el aterrizaje. El sonido dura unos segundos y es id√©ntico en todos los vuelos.'});

  tl.push({min:dur, icon:'üõ¨', c:'ok', type:'flight', title:'Aterrizaje ‚Äî pista ' + arrR.id, desc:'Toma de tierra en ' + tAP.city + '. Escuchar√°s la reversa de empuje y ver√°s los spoilers levantarse en el ala. Despu√©s, ~' + tAP.taxi + ' minutos de rodaje hasta la terminal.'});

  tl.sort(function(a,b){ return a.min - b.min; });

  // (Old separate "lo que siempre pasa" timeline removed ‚Äî now unified)

  // ---- NARRATIVE ----
  var narr = 'Vas a despegar probablemente por la <span class="hi">pista ' + depR.id + '</span> con direcci√≥n ' + card(depR.h) + '.';
  narr += ' A los dos minutos, el avi√≥n girar√° hacia la <span class="hi">' + tDir + '</span> (' + card(rHdg) + '). El viraje dura aproximadamente ' + turnSec + ' segundos.';

  // Climb cloud narrative
  if (originLayers.length > 0) {
    narr += '<br><br>';
    for (var nl = 0; nl < originLayers.length; nl++) {
      var nlay = originLayers[nl];
      var enterT = minAtAlt(nlay.baseM, 'climb');
      var exitT = minAtAlt(nlay.topM, 'climb');
      if (nl > 0) narr += ' ';
      narr += 'Sobre el <span class="hc">minuto ' + enterT + ' entrar√°s en una capa ' + (nlay.thick ? 'densa' : 'parcial') + ' de nubes</span> (' + nlay.maxCover + '%, entre ' + altStr(nlay.baseM) + ' y ' + altStr(nlay.topM) + '). ' + cloudVisual(nlay.thick);
      narr += ' <span class="hc">Saldr√°s sobre el minuto ' + exitT + '</span>.';
    }
  } else {
    narr += '<br><br><span class="hg">No se prev√©n nubes significativas durante el ascenso</span> ‚Äî podr√°s ver el paisaje durante toda la subida.';
  }

  // Cruise
  if (routeTurb) {
    narr += '<br><br>En crucero, es posible que el avi√≥n encuentre <span class="hc">zonas de nubes altas que ocasionen algo de turbulencia</span>.';
  } else {
    narr += '<br><br>Una vez alcanzada la altitud de crucero, <span class="hg">no se prev√©n nubes a la altura de vuelo</span>. Vuelo tranquilo.';
  }

  // Descent
  narr += '<br><br>Para aterrizar en ' + tAP.city;
  if (destLayers.length > 0) {
    narr += ', hay nubes en el descenso:';
    for (var ndl = 0; ndl < destLayers.length; ndl++) {
      var ndlay = destLayers[ndl];
      narr += ' <span class="hc">capa ' + (ndlay.thick ? 'densa' : 'parcial') + ' (' + ndlay.maxCover + '%) entre ' + altStr(ndlay.topM) + ' y ' + altStr(ndlay.baseM) + '</span>';
      if (ndl < destLayers.length - 1) narr += ',';
    }
    narr += '. Los pilotos disponen de instrumentos de precisi√≥n para aterrizar con total seguridad incluso sin visibilidad exterior.';
  } else {
    narr += ' <span class="hg">el cielo est√° despejado</span> ‚Äî podr√°s ver la aproximaci√≥n completa.';
  }
  narr += ' Aterrizar√°s por la <span class="hi">pista ' + arrR.id + '</span>, con aproximadamente ' + tAP.taxi + ' minutos de rodaje hasta la terminal.';

  // Seat
  var sN = '';
  if (seat && seat.length > 0) {
    var lc = seat.charAt(seat.length - 1).toUpperCase();
    var side = (lc <= 'C') ? 'izquierdo' : 'derecho';
    var vD = (side === 'izquierdo') ? card((rHdg - 90 + 360) % 360) : card((rHdg + 90) % 360);
    sN = 'Est√°s en el <span class="hi">lado ' + side + '</span>. Durante crucero tendr√°s vistas hacia el <span class="hi">' + vD + '</span>.';
  }

  // Format departure/arrival times
  var depTimeStr = null, arrTimeStr = null;
  if (fl.depTime) {
    var dt = new Date(fl.depTime.replace(/[+-]\d{2}:\d{2}$/, ''));
    depTimeStr = ('0'+dt.getUTCHours()).slice(-2) + ':' + ('0'+dt.getUTCMinutes()).slice(-2);
  }
  if (fl.arrTime) {
    var at = new Date(fl.arrTime.replace(/[+-]\d{2}:\d{2}$/, ''));
    arrTimeStr = ('0'+at.getUTCHours()).slice(-2) + ':' + ('0'+at.getUTCMinutes()).slice(-2);
  }

  return {tl:tl, narr:narr, sN:sN, ac:ac, oW:oW, dW:dW, depR:depR, arrR:arrR, dur:dur, fAP:fAP, tAP:tAP, fl:fl, isRealWeather:isRealWeather, depTimeStr:depTimeStr, arrTimeStr:arrTimeStr, routeTurb:routeTurb};
}

// ============================================================
// RENDER
// ============================================================
function renderTL(items) {
  var h = '';
  for (var i = 0; i < items.length; i++) {
    var t = items[i];
    var last = (i === items.length - 1);
    var isGeneric = (t.type === 'always');

    var dotC = 'tl-dot-acc';
    if (t.c === 'cld') dotC = 'tl-dot-cld';
    if (t.c === 'ok') dotC = 'tl-dot-ok';
    if (t.c === 'wrn') dotC = 'tl-dot-wrn';
    if (t.c === 'ev') dotC = isGeneric ? 'tl-dot-gen' : 'tl-dot-ev';

    var titleCol = '#4e9eff';
    if (t.c === 'cld') titleCol = '#a78bfa';
    if (t.c === 'ok') titleCol = '#34d399';
    if (t.c === 'wrn') titleCol = '#94a3b8';
    if (t.c === 'ev') titleCol = isGeneric ? '#64748b' : '#fb923c';

    var ml;
    if (t.min < 0) ml = Math.abs(t.min) + "' antes";
    else if (t.min < 1) ml = 'Despegue';
    else ml = Math.round(t.min) + ' min';

    var itemClass = 'tl-item' + (isGeneric ? ' tl-item-gen' : '');
    h += '<div class="' + itemClass + '"><div class="tl-left"><span class="tl-time">' + ml + '</span><span class="tl-dot ' + dotC + '"></span>' + (!last ? '<span class="tl-line"></span>' : '') + '</div>';
    h += '<div class="tl-right"><div class="tl-title" style="color:' + titleCol + '">' + t.icon + ' ' + t.title + '</div>';
    if (isGeneric) {
      h += '<div class="tl-gen">' + t.desc + '</div>';
    } else {
      h += '<div class="tl-desc">' + t.desc + '</div>';
    }
    if (t.re) h += '<div class="tl-safe">‚úì ' + t.re + '</div>';
    h += '</div></div>';
  }
  return h;
}

function renderBriefing(b) {
  var code = document.getElementById('inFlight').value;
  var seatV = document.getElementById('inSeat').value || '‚Äî';
  var h = '';

  // Header
  h += '<div class="header fi"><button class="back" id="btnBack"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><path d="M15 18l-6-6 6-6"/></svg></button>';
  h += '<div class="route"><div class="route-codes">' + b.fl.from + '<span class="route-arrow">‚Üí</span>' + b.fl.to + '</div>';
  h += '<div class="route-sub">' + b.fAP.name + ' ‚Üí ' + b.tAP.name + ' ¬∑ ' + b.ac.n + '</div></div>';
  h += '<span class="badge">' + code + '</span></div>';

  // FIX #5: Duration box with departure/arrival times
  h += '<div class="dur-box fi">';
  if (b.depTimeStr && b.arrTimeStr) {
    h += '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">';
    h += '<div style="text-align:left"><div style="font-size:22px;font-weight:700;color:#e2e8f0">' + b.depTimeStr + '</div><div style="font-size:12px;color:#7a8ba8">' + b.fl.from + ' ¬∑ hora local</div></div>';
    h += '<div style="text-align:center;flex:1;padding:0 12px"><div style="border-top:1px dashed #334155;position:relative;top:0"><span style="position:relative;top:-10px;background:#0f172a;padding:0 8px;font-size:13px;color:#94a3b8">‚úàÔ∏è ' + Math.floor(b.dur/60) + 'h ' + (b.dur%60) + 'min</span></div></div>';
    h += '<div style="text-align:right"><div style="font-size:22px;font-weight:700;color:#e2e8f0">' + b.arrTimeStr + '</div><div style="font-size:12px;color:#7a8ba8">' + b.fl.to + ' ¬∑ hora local</div></div>';
    h += '</div>';
  } else {
    h += '<span class="dur-label">Duraci√≥n media del vuelo</span><span class="dur-val">' + Math.floor(b.dur/60) + 'h ' + (b.dur%60) + 'min</span>';
  }
  h += '</div>';

  // Badge - real or simulated weather
  if (b.isRealWeather) {
    h += '<div class="live fi"><span class="live-dot"></span> Datos meteorol√≥gicos en tiempo real (Open-Meteo)</div>';
  } else {
    h += '<div class="live fi" style="background:rgba(251,191,36,.1);border-color:rgba(251,191,36,.2)"><span class="live-dot" style="background:#fbbf24"></span> <span style="color:#fbbf24">Datos meteorol√≥gicos simulados</span></div>';
  }

  // Turbulence estimate (moved up) ‚Äî 4 scales, non-alarming colors
  // 0=imperceptible, 1=baja, 2=baja/media, 3=media/fuerte
  var turbLevel = 0;
  if (b.routeTurb) turbLevel = 2; // clouds at cruise = baja/media
  var turbInfo = [
    {label:'Imperceptible', color:'#4e9eff', width:'10%'},
    {label:'Baja', color:'#7a8ba8', width:'30%'},
    {label:'Baja / Media', color:'#94a3b8', width:'55%'},
    {label:'Media / Fuerte', color:'#64748b', width:'80%'}
  ][turbLevel];

  h += '<div class="card fi">';
  h += '<div class="card-title">‚úàÔ∏è Turbulencia estimada</div>';
  h += '<div class="turb-bar"><div class="turb-fill" style="width:' + turbInfo.width + ';background:' + turbInfo.color + '"></div></div>';
  h += '<div style="display:flex;justify-content:space-between;font-size:11px;color:#4a5873;margin-top:4px"><span>Imperceptible</span><span>Baja</span><span>Baja/Media</span><span>Media/Fuerte</span></div>';
  h += '<div style="text-align:center;margin-top:8px;font-size:14px;font-weight:500;color:' + turbInfo.color + '">' + turbInfo.label + '</div>';
  h += '</div>';

  // Safety banner
  h += '<div class="safety fi"><span style="font-size:20px">üõ°Ô∏è</span><div class="safety-text">La aviaci√≥n comercial es el medio de transporte m√°s seguro del mundo. Todo lo que lees aqu√≠ forma parte del funcionamiento normal de <strong>todos</strong> los vuelos.</div></div>';

  // Narrative
  h += '<div class="card fi"><div class="card-title">‚úÖ Tu briefing</div><div class="narr">' + b.narr + '</div></div>';

  // Cloud visual ‚Äî vertical profile
  h += '<div class="card fi"><div class="card-title">‚òÅÔ∏è Perfil de nubes ‚Äî ' + b.fAP.city + '</div>';
  h += '<div style="background:#0d1220;border-radius:10px;padding:16px">';
  if (b.oW.profile) {
    var profLabels = ['100m','750m','1.500m','3.000m','4.200m','5.500m','7.200m','9.200m','10.400m','11.800m'];
    for (var pi = b.oW.profile.length - 1; pi >= 0; pi--) {
      var pp = b.oW.profile[pi];
      var barCol = pp.cover > 30 ? 'cv-bar-cld' : 'cv-bar-ok';
      var opacity = pp.cover > 60 ? '' : (pp.cover > 30 ? 'opacity:.6' : '');
      h += '<div class="cv-row"><span class="cv-alt">' + profLabels[pi] + '</span><div class="cv-wrap"><div class="cv-bar ' + barCol + '" style="width:' + pp.cover + '%;' + opacity + '"></div></div><span class="cv-pct">' + pp.cover + '%</span></div>';
    }
  } else {
    h += '<div class="cv-row"><span class="cv-alt">+6.000m</span><div class="cv-wrap"><div class="cv-bar ' + (b.oW.cH > 40 ? 'cv-bar-cld' : 'cv-bar-ok') + '" style="width:' + b.oW.cH + '%"></div></div><span class="cv-pct">' + b.oW.cH + '%</span></div>';
    h += '<div class="cv-row"><span class="cv-alt">2-6.000m</span><div class="cv-wrap"><div class="cv-bar ' + (b.oW.cM > 40 ? 'cv-bar-cld' : 'cv-bar-ok') + '" style="width:' + b.oW.cM + '%"></div></div><span class="cv-pct">' + b.oW.cM + '%</span></div>';
    h += '<div class="cv-row"><span class="cv-alt">0-2.000m</span><div class="cv-wrap"><div class="cv-bar ' + (b.oW.cL > 40 ? 'cv-bar-cld' : 'cv-bar-ok') + '" style="width:' + b.oW.cL + '%"></div></div><span class="cv-pct">' + b.oW.cL + '%</span></div>';
  }
  h += '</div>';
  h += '<div style="margin-top:12px;font-size:13px;color:#7a8ba8">Tu avi√≥n cruzar√° entre FL300 y FL400 (~9-12km), <span class="hg">por encima de casi todas las capas</span>.</div>';
  h += '</div>';

  // Unified Flight timeline
  h += '<div class="card fi"><div class="card-title">üïê Timeline completo</div>';
  h += '<div style="margin-bottom:12px;font-size:12px;color:#7a8ba8">Los eventos <span style="color:#4e9eff">en azul</span> son espec√≠ficos de tu vuelo. Los eventos <span style="color:#94a3b8">en gris</span> ocurren en todos los vuelos.</div>';
  h += renderTL(b.tl) + '</div>';

  // Conditions
  h += '<div class="card fi"><div class="card-title">üå°Ô∏è Condiciones</div>';
  h += '<div class="cond-grid">';
  h += '<div class="cond-box"><div class="cond-val" style="color:#34d399">' + b.oW.temp + '¬∞C</div><div class="cond-lbl">' + b.fAP.city + ' ahora</div></div>';
  h += '<div class="cond-box"><div class="cond-val" style="color:#4e9eff">' + b.dW.temp + '¬∞C</div><div class="cond-lbl">' + b.tAP.city + ' llegada</div></div>';
  h += '<div class="cond-box"><div class="cond-val">' + b.oW.ws + ' km/h</div><div class="cond-lbl">Viento ' + b.fl.from + '</div></div>';
  h += '<div class="cond-box"><div class="cond-val">' + b.dW.ws + ' km/h</div><div class="cond-lbl">Viento ' + b.fl.to + '</div></div>';
  h += '</div></div>';

  // Seat
  if (b.sN) {
    h += '<div class="card fi"><div class="card-title">üëÅÔ∏è Tu ventanilla ¬∑ ' + seatV + '</div><div class="narr">' + b.sN + '</div></div>';
  }

  // Sound guide
  h += '<div class="card fi"><div class="card-title">üîä Gu√≠a de sonidos ¬∑ ' + b.ac.n + '</div><div class="narr" style="font-size:14px">';
  if (b.ac.bark) h += '<span class="he">üîä "Barking dog"</span> ‚Äî Sonido r√≠tmico como un ladrido. Sistema hidr√°ulico PTU. Solo Airbus.<br><br>';
  h += '<span class="he">‚öôÔ∏è Tren de aterrizaje</span> ‚Äî Golpe seco seguido de zumbido al guardar o desplegar las ruedas.<br><br>';
  h += '<span class="he">‚öôÔ∏è Flaps y slats</span> ‚Äî Piezas del borde del ala que se mueven. Zumbido suave.<br><br>';
  h += '<span class="he">‚öôÔ∏è Spoilers</span> ‚Äî Placas que se levantan en el ala al aterrizar. Visibles desde la ventanilla.<br><br>';
  h += '<span class="he">üîä Cambios de potencia</span> ‚Äî Los motores var√≠an su intensidad durante el vuelo. Nunca se apagan.<br><br>';
  h += '<span class="he">üîî Se√±ales ac√∫sticas</span> ‚Äî Comunicaci√≥n entre pilotos y tripulaci√≥n, o indicador de cinturones.';
  h += '</div></div>';

  h += '<div class="spacer"></div>';

  document.getElementById('OUT').innerHTML = h;
  document.getElementById('btnBack').onclick = goBack;
}

// ============================================================
// NAVIGATION
// ============================================================
function showScr(show, hide, dir) {
  document.getElementById(hide).className = 'scr ' + (hide === 'S1' ? 'search' : hide === 'S2' ? 'loading' : 'brief') + (dir === 'f' ? ' off-l' : ' off-r');
  var s = document.getElementById(show);
  s.className = 'scr ' + (show === 'S1' ? 'search' : show === 'S2' ? 'loading' : 'brief');
}

function goBack() {
  var steps = ['st1','st2','st3','st4','st5'];
  for (var i = 0; i < steps.length; i++) {
    document.getElementById(steps[i]).className = 'step';
  }
  showScr('S1', 'S3', 'b');
  document.getElementById('S2').className = 'scr loading off-r';
}

function delay(ms) {
  return new Promise(function(resolve) { setTimeout(resolve, ms); });
}

async function analyze() {
  var code = document.getElementById('inFlight').value.trim().toUpperCase();
  var seat = document.getElementById('inSeat').value.trim().toUpperCase();
  var acSel = document.getElementById('inAC').value;

  if (!code) {
    document.getElementById('inFlight').style.borderColor = '#f87171';
    setTimeout(function(){ document.getElementById('inFlight').style.borderColor = ''; }, 1200);
    return;
  }

  var fl = FLIGHTS[code];
  if (!fl) {
    try {
      var apiUrl = '/api/flight?number=' + encodeURIComponent(code);
      var apiR = await fetch(apiUrl);
      if (apiR.ok) {
        var apiData = await apiR.json();
        if (!apiData.error && apiData.departure && apiData.arrival) {
          var cruiseFl = 360;
          var dur = apiData.durationMin || 120;
          if (dur < 60) cruiseFl = 280;
          else if (dur < 90) cruiseFl = 320;
          else if (dur < 150) cruiseFl = 360;
          else cruiseFl = 380;
          fl = { al: apiData.flight.airline || code.substring(0,2), from: apiData.departure.iata, to: apiData.arrival.iata, dur: dur, ac: apiData.aircraft.type || 'A320', fl: cruiseFl, depTime: apiData.departure.scheduledLocal, arrTime: apiData.arrival.scheduledLocal, depTz: apiData.departure.timezone, arrTz: apiData.arrival.timezone };
          if (!AP[fl.from] && apiData.departure.lat) {
            AP[fl.from] = { name: apiData.departure.name, city: apiData.departure.name, lat: apiData.departure.lat, lon: apiData.departure.lon, taxi: 10, dep: function(wd,ws){ if(ws<5)return{id:'01',h:10}; if(wd>=315||wd<45)return{id:'36',h:360}; if(wd>=45&&wd<135)return{id:'09',h:90}; if(wd>=135&&wd<225)return{id:'18',h:180}; return{id:'27',h:270}; }, arr: function(wd,ws){ if(ws<5)return{id:'01',h:10}; if(wd>=315||wd<45)return{id:'36',h:360}; if(wd>=45&&wd<135)return{id:'09',h:90}; if(wd>=135&&wd<225)return{id:'18',h:180}; return{id:'27',h:270}; } };
          }
          if (!AP[fl.to] && apiData.arrival.lat) {
            AP[fl.to] = { name: apiData.arrival.name, city: apiData.arrival.name, lat: apiData.arrival.lat, lon: apiData.arrival.lon, taxi: 10, dep: function(wd,ws){ if(ws<5)return{id:'01',h:10}; if(wd>=315||wd<45)return{id:'36',h:360}; if(wd>=45&&wd<135)return{id:'09',h:90}; if(wd>=135&&wd<225)return{id:'18',h:180}; return{id:'27',h:270}; }, arr: function(wd,ws){ if(ws<5)return{id:'01',h:10}; if(wd>=315||wd<45)return{id:'36',h:360}; if(wd>=45&&wd<135)return{id:'09',h:90}; if(wd>=135&&wd<225)return{id:'18',h:180}; return{id:'27',h:270}; } };
          }
        }
      }
    } catch(e) { console.log('API error:', e); }
  }
  if (!fl) {
    var inp = document.getElementById('inFlight');
    inp.style.borderColor = '#f87171';
    inp.value = '';
    inp.placeholder = 'Vuelo no encontrado';
    setTimeout(function(){ inp.style.borderColor = ''; inp.placeholder = 'Ej: IB3170'; }, 3000);
    return;
  }

  var acCode = (acSel !== 'auto') ? acSel : fl.ac;
  var fAP = AP[fl.from];
  var tAP = AP[fl.to];

  showScr('S2', 'S1', 'f');

  var steps = ['st1','st2','st3','st4','st5'];
  // Step 1: flight found
  document.getElementById(steps[0]).className = 'step on';
  await delay(400);
  document.getElementById(steps[0]).className = 'step ok';

  // Step 2 & 3: fetch real weather (in parallel with animation)
  document.getElementById(steps[1]).className = 'step on';
  var weatherData = null;
  try {
    weatherData = await fetchRouteWeather(fAP, tAP);
  } catch(e) { console.log('Weather fetch failed, using simulated', e); }
  document.getElementById(steps[1]).className = 'step ok';

  document.getElementById(steps[2]).className = 'step on';
  await delay(400);
  document.getElementById(steps[2]).className = 'step ok';

  // Step 4: predict runway
  document.getElementById(steps[3]).className = 'step on';
  await delay(400);
  document.getElementById(steps[3]).className = 'step ok';

  // Step 5: build briefing
  document.getElementById(steps[4]).className = 'step on';
  await delay(300);
  document.getElementById(steps[4]).className = 'step ok';
  await delay(200);

  var briefing = makeBriefing(fl, fAP, tAP, seat, acCode, weatherData);
  renderBriefing(briefing);
  showScr('S3', 'S2', 'f');
}

// ============================================================
// INIT
// ============================================================
document.getElementById('inDate').value = new Date().toISOString().split('T')[0];

document.getElementById('inFlight').addEventListener('input', function() {
  this.value = this.value.toUpperCase().replace(/[^A-Z0-9]/g, '');
});
document.getElementById('inSeat').addEventListener('input', function() {
  this.value = this.value.toUpperCase().replace(/[^A-Z0-9]/g, '');
});

document.getElementById('btnGo').addEventListener('click', function() { analyze(); });

var chips = document.querySelectorAll('.chip');
for (var c = 0; c < chips.length; c++) {
  chips[c].addEventListener('click', function() {
    document.getElementById('inFlight').value = this.getAttribute('data-f');
    document.getElementById('inSeat').value = this.getAttribute('data-s') || '';
  });
}
</script>
</body>
</html>
